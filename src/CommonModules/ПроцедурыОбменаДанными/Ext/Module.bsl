///////////////////////////////////////////////////////////////////////////////
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ

//ФОРМА ХОДА ОБРАБОТКИ

// Процедура показывает новое сообщение в форме хода обработки данных
Процедура ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураОбменаДанными, Знач ТекстСообщения, Знач ПроцентПрибавления = 0)
	#Если Сервер Тогда
		ПараметрЗапуска = ПараметрЗапуска;
	#КонецЕсли	
	Если ЗначениеЗаполнено(ПараметрЗапуска) Тогда
		Возврат;
	КонецЕсли;
	
	#Если Клиент Тогда
		
		СтруктураОбменаДанными.ФормаХодаВыполненияОбмена.КомментарийОбработкиДанных = ТекстСообщения;	
		СтруктураОбменаДанными.ФормаХодаВыполненияОбмена.Значение = СтруктураОбменаДанными.ФормаХодаВыполненияОбмена.Значение + ПроцентПрибавления;
		
	 #КонецЕсли
	
КонецПроцедуры

// Процедура показывает новое сообщение в форме хода обработки данных
Процедура ИнициализироватьФормуХодаОбработки(СтруктураОбменаДанными, Знач ТекстСообщения = "", Знач ПроцентПрибавления = 0)
	#Если Сервер Тогда
		ПараметрЗапуска = ПараметрЗапуска;
	#КонецЕсли	

	Если ЗначениеЗаполнено(ПараметрЗапуска) Тогда
		Возврат;
	КонецЕсли;
	
	#Если Клиент Тогда
		
		ФормаХодаВыполненияОбмена = Неопределено;
		СтруктураОбменаДанными.Свойство("ФормаХодаВыполненияОбмена", ФормаХодаВыполненияОбмена);
		
		Если ФормаХодаВыполненияОбмена = Неопределено Тогда
			
			ФормаХодаВыполненияОбмена = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
			СтруктураОбменаДанными.Вставить("ФормаХодаВыполненияОбмена", ФормаХодаВыполненияОбмена);
			
		Иначе	
			ФормаХодаВыполненияОбмена = СтруктураОбменаДанными.ФормаХодаВыполненияОбмена; 	
		КонецЕсли;
		
		ФормаХодаВыполненияОбмена.НаименованиеОбработкиДанных = "Обмен данными по настройке: " + СтруктураОбменаДанными.ДанныеНастройки.Наименование;
		ФормаХодаВыполненияОбмена.КомментарийОбработкиДанных = ТекстСообщения;	
		ФормаХодаВыполненияОбмена.Значение = ПроцентПрибавления;
		ФормаХодаВыполненияОбмена.МаксимальноеЗначение = 100;
		
		Если Не ФормаХодаВыполненияОбмена.Открыта() Тогда
			Попытка
				ФормаХодаВыполненияОбмена.Открыть();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

//Процедура закрывает форму хода обработки данных
Процедура ЗакрытьФормуОбработкиДанных(СтруктураОбменаДанными)
	#Если Сервер Тогда
		ПараметрЗапуска = ПараметрЗапуска;
	#КонецЕсли	

	Если ЗначениеЗаполнено(ПараметрЗапуска) Тогда
		Возврат;
	КонецЕсли;
		
	#Если Клиент Тогда
		
		ФормаХодаВыполненияОбмена = Неопределено;
		СтруктураОбменаДанными.Свойство("ФормаХодаВыполненияОбмена", ФормаХодаВыполненияОбмена);
		Если ФормаХодаВыполненияОбмена <> Неопределено Тогда
			
			Если ФормаХодаВыполненияОбмена.Открыта() Тогда
				Попытка
					ФормаХодаВыполненияОбмена.Закрыть();	
				Исключение
				КонецПопытки;
				
			КонецЕсли;
			
			СтруктураОбменаДанными.ФормаХодаВыполненияОбмена = Неопределено; 	
			
		КонецЕсли;
	
	#КонецЕсли
	
КонецПроцедуры
           
// функция возвращает используется ли механизм автоматического обмена данными или нет
Функция ИспользоватьМеханизмАвтоматическогоОбмена() Экспорт
	
	// нужно ли автообмен данными проводить
	ИспользоватьАвтообмен = ПараметрыСеанса.ТекущаяИБ.ИспользоватьМеханизмАвтоматическогоОбменаДанными;
	
	Возврат ИспользоватьАвтообмен;
	
КонецФункции

// функция нормализует ftp адрес (отрезает не нужное)
Функция НормализоватьFTPАдрес(Знач FTPАдрес) Экспорт
	
	ИтоговыйАдрес = СокрЛП(FTPАдрес);
	ПозицияFTP = Найти(Врег(ИтоговыйАдрес), "FTP://");
	
	Если ПозицияFTP = 1 Тогда
		
		ИтоговыйАдрес = Сред(ИтоговыйАдрес, 7);	
		
	КонецЕсли;
	
	Возврат ИтоговыйАдрес;
	
КонецФункции

// Процедура выполняет удаление файла
Функция ВыполнитьУдалениеФайла(Знач ИмяФайлаУдаления, СтруктураНастроекОбменаДанными, Знач ВыводитьИнформациюВПротокол = Ложь)
	
	//СтруктураНастроекОбменаДанными.ДанныеПротокола, СтруктураНастроекОбменаДанными.РучнойРежимЗапуска
	
	Если ПустаяСтрока(ИмяФайлаУдаления) Тогда
		Возврат Истина;
	КонецЕсли;
	
	Попытка
		
		Если ВыводитьИнформациюВПротокол Тогда
			ДобавитьИнформациюВПротокол("Удаление файла: " + ИмяФайлаУдаления, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		КонецЕсли;
	
		УдалитьФайлы(ИмяФайлаУдаления);
		
	Исключение
		
		Если ВыводитьИнформациюВПротокол Тогда
			СообщитьИнформациюОбОшибкеОбмена("Ошибка при попытке удаления файла: " + ИмяФайлаУдаления + " " + ОписаниеОшибки(), 
				СтруктураНастроекОбменаДанными);
		КонецЕсли;
			
		Возврат Ложь;	
		 
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

// Процедура выполняет копирование файла
Функция ВыполнитьКопированиеФайла(Знач ИмяФайлаИсточника, Знач ИмяФайлаПриемника, Знач ВыводитьИнформациюВПротокол = Ложь, СтруктураНастроекОбменаДанными)
	
	Попытка
		
		Если ВыводитьИнформациюВПротокол Тогда
			ДобавитьИнформациюВПротокол("Копирование файла из  " + ИмяФайлаИсточника + " в " + ИмяФайлаПриемника, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		КонецЕсли;
	
		КопироватьФайл(ИмяФайлаИсточника, ИмяФайлаПриемника);
		
	Исключение
		
		Если ВыводитьИнформациюВПротокол Тогда
			
			СообщитьИнформациюОбОшибкеОбмена("Ошибка при копировании файла из  " + ИмяФайлаИсточника + " в " + ИмяФайлаПриемника + 
				Символы.ПС + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);
				
		КонецЕсли;
			
		Возврат Ложь;	
		 
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

// Процедура меняет расширение имени файла обмена и выполняет проверку наличия каталога для работы
Процедура ПроверитьДоступностьРаботыСКаталогом(ИмяФайлаЧтенияИзменений, Знач НужноМенятьРасширениеНаZIP = Ложь)
	
	Если НужноМенятьРасширениеНаZIP Тогда
		РаботаСФайлами.УстановитьРасширениеФайла(ИмяФайлаЧтенияИзменений, ".zip");
	КонецЕсли;

	//надо убедиться в том что каталог куда все будем сохранять существует
	СоздатьКаталогПоПолномуПутиКФайлу(ИмяФайлаЧтенияИзменений);
	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ КОНФИГУРАЦИИ

// функция возвращает настройки для формирования файла обновления конфигурации
Функция ПолучитьНастройкиДляФайлаОбновленияКонфигурации() Экспорт
	
	//Если НЕ ПравоДоступа("Чтение", Метаданные.Константы.НастройкаФайлаОбновленияКонфигурации) Тогда
	//	Возврат Неопределено;
	//КонецЕсли;
	
	// получаем сами настройки
	//НастройкиДляОбновленияКонфигурации = Константы.НастройкаФайлаОбновленияКонфигурации.Получить();
	
	//Если НастройкиДляОбновленияКонфигурации <> Неопределено Тогда
	//	
	//	Возврат НастройкиДляОбновленияКонфигурации.Получить();
	//	
	//Иначе
		
		Возврат Неопределено;
		
	//КонецЕсли;
	
КонецФункции

// Функция устанавливает настройки для файла обновления конфигурации
Функция УстановитьНастройкиДляФайлаОбновленияКонфигурации(СтруктураНастроек) Экспорт
	
	//Если НЕ ПравоДоступа("Изменение", Метаданные.Константы.НастройкаФайлаОбновленияКонфигурации) Тогда
	//	
	//	СообщитьИнформациюОПростойОшибке("Нет прав на изменение константы ""Настройка файла обновления конфигурации""");
	//		
	//	Возврат Ложь;
	//КонецЕсли;
	
	//Попытка
	//	
	//	ЗначениеХранилища = Новый ХранилищеЗначения(СтруктураНастроек);
	//	Константы.НастройкаФайлаОбновленияКонфигурации.Установить(ЗначениеХранилища);
	//	
	//Исключение
	//	
	//	СообщитьИнформациюОПростойОшибке("Ошибка при установке константы ""Настройка файла обновления конфигурации"": " + ОписаниеОшибки());
		Возврат Ложь;
		
	//КонецПопытки;
	//
	//Возврат Истина;

КонецФункции

// функция создает параметры настроек обновления конфигурации по умолчанию
Функция СоздатьПараметрыНастроекОбновленияКонфигурацииПоУмолчанию() Экспорт
	
	ПараметрыНастроек = Новый Структура();
	
	ПараметрыНастроек.Вставить("ФормироватьФайлОбновленияКонфигурацииАвтоматически", Истина);
	ПараметрыНастроек.Вставить("ИмяАдминистратораИнформационнойБазы", "");
	ПараметрыНастроек.Вставить("ИмяФайлаДляЗаписиОшибок", "");
	
	Возврат ПараметрыНастроек;
	
КонецФункции

// Процедура определяет параметры БАТ файла для обновления конфигурации
Процедура СформироватьПараметрыДляОбновленияКонфигурации(ИмяПользователяБД, ИмяПрограммыЗапуска, ПутьКБД, ФайловаяБД)
	
	// создается BAT файл по установленному макету и запускается
	
	СтрокаСоединенияСБД = СтрокаСоединенияИнформационнойБазы();
	ЭтоФайловаяИБ = ОпределитьЭтаИнформационнаяБазаФайловая(СтрокаСоединенияСБД);
			
	Если ЭтоФайловаяИБ Тогда
		ПутьКБД = Сред(СтрокаСоединенияСБД, 6, СтрДлина(СтрокаСоединенияСБД) - 6);
		ФайловаяБД = Истина;
	Иначе
		// надо к имени сервера прибавить имя пути БД  !!!
		ПозицияПоиска = Найти(Врег(СтрокаСоединенияСБД), "SRVR=");
		
		Если ПозицияПоиска <> 1 Тогда
			Возврат;
		КонецЕсли;
		
		ПозицияТочкиСЗапятой = Найти(СтрокаСоединенияСБД, ";");
		НачальнаяПозицияКопирования = 6 + 1;
		КонечнаяПозицияКопирования = ПозицияТочкиСЗапятой - 2; 
		
		ИмяСервера = Сред(СтрокаСоединенияСБД, НачальнаяПозицияКопирования, КонечнаяПозицияКопирования - НачальнаяПозицияКопирования + 1);
		
		СтрокаСоединенияСБД = Сред(СтрокаСоединенияСБД, ПозицияТочкиСЗапятой + 1);
		
		// позиция имени сервера
		ПозицияПоиска = Найти(Врег(СтрокаСоединенияСБД), "REF=");
		
		Если ПозицияПоиска <> 1 Тогда
			Возврат;
		КонецЕсли;
				
		НачальнаяПозицияКопирования = 6;
		ПозицияТочкиСЗапятой = Найти(СтрокаСоединенияСБД, ";");
		КонечнаяПозицияКопирования = ПозицияТочкиСЗапятой - 2; 
		
		ИмяИБНаСервере = Сред(СтрокаСоединенияСБД, НачальнаяПозицияКопирования, КонечнаяПозицияКопирования - НачальнаяПозицияКопирования + 1);
		
		ПутьКБД = """" + ИмяСервера + "\" + ИмяИБНаСервере + """";
		ФайловаяБД = Ложь;
		
	КонецЕсли;
	
	ИмяПрограммыЗапуска = РаботаСФайлами.ПолучитьИмяФайла(КаталогПрограммы(), "1cv8.exe");
    	
	ИмяПользователяБД = ИмяПользователя();
	
КонецПроцедуры

// Функция определения базы, файловая или не файловая
Функция ОпределитьЭтаИнформационнаяБазаФайловая(СтрокаСоединенияСБД = "") Экспорт
			
	Возврат ирКэш.ЭтоФайловаяБазаЛкс();
	
	
КонецФункции

// функция по пользователю ИБ определяет есть ли у него Windows авторизация
Функция НаличиеУПользователяWindowsАвторизации(Знач ИмяПользователяИБ)
	
	Если ПустаяСтрока(ИмяПользователяИБ) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// находим пользователя ИБ
	ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоИмени(ИмяПользователяИБ);
	Если ПользовательИБ = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат ПользовательИБ.АутентификацияОС;
	
КонецФункции

// Функция формирует логин пользователя для подключения к ИБ
Функция СформироватьЛогинПодключенияКИБ(Знач ИмяПользователяБД)
	
	Если Не ПустаяСтрока(ИмяПользователяБД) Тогда
		
		ТребуетсяАвторизацияОС = НаличиеУПользователяWindowsАвторизации(ИмяПользователяБД);
		
		КлючАвторизации = ?(ТребуетсяАвторизацияОС, "/WA+", "/WA-"); 
		
		ПользовательБД = "/N""" + ИмяПользователяБД + """ " + КлючАвторизации;
	Иначе
		ПользовательБД = "";
	КонецЕсли;
	
	Возврат ПользовательБД;
	
КонецФункции

// Функция формирует часть бат файла (объявления) для обновления конфигурации
Функция СформироватьЧастьОбъявленийПодключенияТекущегоПользователя()
	
	Перем ИмяПользователяБД, ИмяПрограммыЗапуска, ПутьКБД, ФайловаяБД;
	
	СформироватьПараметрыДляОбновленияКонфигурации(ИмяПользователяБД, ИмяПрограммыЗапуска, ПутьКБД, ФайловаяБД);
	
	ТекстФайлаПоУмолчанию = Символы.ПС;
	
	ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + "set v8exe=""" + ИмяПрограммыЗапуска + """" + Символы.ПС;
	ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + "set DataBaseName=" + ПутьКБД + Символы.ПС;
	
	Если ФайловаяБД Тогда	
		ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + "set DataBase=/F%DataBaseName%" + Символы.ПС;
	Иначе
		ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + "set DataBase=/S%DataBaseName%" + Символы.ПС;
	КонецЕсли;
	
	ПользовательБД = СформироватьЛогинПодключенияКИБ(ИмяПользователяБД);
	
	ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + "set User=" + ПользовательБД + Символы.ПС;

	Возврат ТекстФайлаПоУмолчанию;
	
КонецФункции

// функция формирует часть бат файла (вызов обновления конфигурации)
Функция СформироватьЧастьВызоваОбновленияКонфигурации(Знач ИмяАдминистратораИБ = "", Знач ИмяФайлаИнформацииОбОшибках = "", 
	Знач ИспользоватьФайлОбОшибкахСПустымИменем = Ложь)
	
	ИмяЛогинаАдминистратора = ?(ПустаяСтрока(ИмяАдминистратораИБ), "", СформироватьЛогинПодключенияКИБ(ИмяАдминистратораИБ));
	
	СтрокаОбъявленияФайлаСообщенийОбОшибках = "";
	СтрокаДляВыводаДанныхВФайл = "";
		
	Если НЕ ПустаяСтрока(ИмяФайлаИнформацииОбОшибках) ИЛИ ИспользоватьФайлОбОшибкахСПустымИменем Тогда
		
		// надо проверить наличие файла для обмена, если его нет то создать его
		СтрокаИмениФайлаИнформацииОбОшибках = СокрЛП(ИмяФайлаИнформацииОбОшибках);
							
		СтрокаОбъявленияФайлаСообщенийОбОшибках = "
			|REM Путь к файлу для ошибок и сообщений
			|set FileInformation=""" + СтрокаИмениФайлаИнформацииОбОшибках + """
			|
			|date /t >> %FileInformation%
			|time /t >> %FileInformation%
			|set DataBaseName>>%FileInformation%";
				
		СтрокаДляВыводаДанныхВФайл = "/Out%FileInformation% -NoTruncate";
					
	КонецЕсли;	
	
	// основной текст
	ТекстФайлаПоУмолчанию = "
		|REM Логин администратора системы
		|set AdminUser=" + ИмяЛогинаАдминистратора + "
        |
		|" + СтрокаОбъявленияФайлаСообщенийОбОшибках + " 
		|
		|rem Завершение работы пользователей
		|start """" /wait %v8exe% ENTERPRISE %DataBase% %AdminUser% /CЗавершитьРаботуПользователей	/UCПакетноеОбновлениеКонфигурацииИБ	" + СтрокаДляВыводаДанныхВФайл + " /DisableStartupMessages
        |
		|start """" /wait %v8exe% CONFIG     %DataBase% %AdminUser% /UpdateDBCfg /UCПакетноеОбновлениеКонфигурацииИБ " + СтрокаДляВыводаДанныхВФайл + "
        |
		|rem Разрешение работы пользователей
		|start """" /wait %v8exe% ENTERPRISE %DataBase% %AdminUser% /CРазрешитьРаботуПользователей	/UCПакетноеОбновлениеКонфигурацииИБ	" + СтрокаДляВыводаДанныхВФайл + " /DisableStartupMessages
		|
		|rem Запуск самой программы
		|start """" %v8exe% ENTERPRISE %DataBase% %User% /CВходПослеОбновленияБазы /DisableStartupMessages";;
		
	Возврат ТекстФайлаПоУмолчанию;
	
КонецФункции

// Функция формирует текст файла обновления конфигурации по умолчанию
Функция ПолучитьТекстНастроекФайлаОбновленияКонфигурацииПоУмолчанию() Экспорт
	
	ТекстФайлаПоУмолчанию = СформироватьЧастьОбъявленийПодключенияТекущегоПользователя();
		                       
	// основной текст
	ТекстФайлаПоУмолчанию = ТекстФайлаПоУмолчанию + СформироватьЧастьВызоваОбновленияКонфигурации(,,Истина);
		
	Возврат ТекстФайлаПоУмолчанию;
	
КонецФункции

// функция формирует текст бат файла обновления конфигурации по структуре данных
Функция СформироватьТекстБатФайлаПоСтруктуре(СтруктураПараметров) Экспорт
	
	ТекстФайла = "";
	
	// автоматически или нет формируется файл с настройками
	ФормироватьФайлОбновленияКонфигурацииАвтоматически = Истина;
	СтруктураПараметров.Свойство("ФормироватьФайлОбновленияКонфигурацииАвтоматически", ФормироватьФайлОбновленияКонфигурацииАвтоматически);
	
	Если ФормироватьФайлОбновленияКонфигурацииАвтоматически = Истина Тогда
		
		// имя администратора информационной базы
		ИмяАдминистратораИнформационнойБазы = "";
		Если Не СтруктураПараметров.Свойство("ИмяАдминистратораИнформационнойБазы", ИмяАдминистратораИнформационнойБазы) Тогда
			
			ИмяАдминистратораИнформационнойБазы = "";
			
		КонецЕсли;
		
		// файл для фиксирования ошибок
		ИмяФайлаДляЗаписиОшибок = "";
		Если Не СтруктураПараметров.Свойство("ИмяФайлаДляЗаписиОшибок", ИмяФайлаДляЗаписиОшибок) Тогда
			
			ИмяФайлаДляЗаписиОшибок = "";
			
		КонецЕсли;

		ТекстФайла = СформироватьЧастьОбъявленийПодключенияТекущегоПользователя();
		
		ТекстФайла = ТекстФайла + СформироватьЧастьВызоваОбновленияКонфигурации(ИмяАдминистратораИнформационнойБазы, ИмяФайлаДляЗаписиОшибок);
		
	Иначе
		// ручное редактирование
		НаличиеСвойства = СтруктураПараметров.Свойство("ТекстФайлаОбновленияКонфигурации", ТекстФайла);
		
		Если Не НаличиеСвойства Тогда
			ТекстФайла = "";
		КонецЕсли;
								
	КонецЕсли;
	
	Возврат ТекстФайла;
	
КонецФункции

// формирование текста бат файла обновления конфигурации по настройкам
Функция СформироватьТекстБатФайлаПоНастройкам() Экспорт
	
	//Если НЕ ПравоДоступа("Чтение", Метаданные.Константы.НастройкаФайлаОбновленияКонфигурации) Тогда
	//	СообщитьИнформациюОПростойОшибке("Нет прав доступа к константе ""Настройка файла обновления конфигурации""");
	//	Возврат "";
	//КонецЕсли;

	СтруктураНастроек = ПолучитьНастройкиДляФайлаОбновленияКонфигурации();
	Если СтруктураНастроек = Неопределено Тогда
		СтруктураНастроек = СоздатьПараметрыНастроекОбновленияКонфигурацииПоУмолчанию();
	КонецЕсли;
		
	ТекстФайла = СформироватьТекстБатФайлаПоСтруктуре(СтруктураНастроек);
	
	Возврат ТекстФайла;
	
КонецФункции

#Если Клиент Тогда

// Обновляет конфигурацию базы данных 
//
Процедура ОбновитьКонфигурациюБазыДанных(НастройкаОбменаДанными) Экспорт

	
	Если Не РольДоступна(Метаданные.Роли.ПолныеПрава) Тогда
		Предупреждение("Не хватает прав для обновления конфигурации базы данных", 5);
		Возврат;
	КонецЕсли;
	
	ТекущийРежим = ПолучитьБлокировкуУстановкиСоединений();

	Если ТекущийРежим.Установлена Тогда
		Предупреждение("Обновление конфигурации базы данных уже производится.", 5);
		Возврат;
	КонецЕсли;
			
	Если Не КонфигурацияИзменена() Тогда
		Предупреждение("Обновление конфигурации базы данных не требуется.
		|Конфигурация базы данных совпадает с основной конфигурацией.", 5);
		Возврат;
	КонецЕсли;
			
	ТекстПредупреждения = Символы.Таб + "Рекомендуем пользоваться автоматическим обновлением конфигурации БД, когда
	|достоверно известно, что внесенные в конфигурацию изменения не повлияют на ее работоспособность.
	|
	|" + Символы.Таб + "Пользоваться автоматическим обновлением конфигурации БД рекомендуется в том случае, если
	|при обмене данными было получено сообщение об ошибке:
	|""Из главного узла распределенной ИБ получены изменения конфигурации.""
	|
	|" + Символы.Таб + "Во всех остальных случаях не рекомендуется автоматически обновлять конфигурацию БД!
	|" + Символы.Таб + "Программа будет перезапущена.
	|" + Символы.Таб + "В процессе обновления ИБ будет предложено 3 раза ввести свои данные для входа в БД.
	|
	|Обновить конфигурацию БД?";
	
	ОтветПользователя = Вопрос(ТекстПредупреждения,  
		РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет, "Изменения конфигурации");
		
	Если ОтветПользователя <> КодВозвратаДиалога.Да Тогда
		// пользователь отказался изменять метаданные	
		Возврат;	
	КонецЕсли;	
	
	// надо для выбранной настройки поставить признак запуска обмена при загрузке данных
	УстановитьНеобходимостьВыполненияОбменаПриПервомЗапускеПрограммы(НастройкаОбменаДанными, Истина);
	
	ПредложитьПерезагрузкуПрограммы(, Истина); 
	          	
КонецПроцедуры

// Процедура формирование BAT-Файла для автоматической перезагрузки программы
Процедура ПредложитьПерезагрузкуПрограммы(СтруктураПараметров = Неопределено, 
	Знач ЗапускатьФайлОбновленияКонфигурации = Ложь) Экспорт
	
	Если СтруктураПараметров = Неопределено Тогда
		// создается BAT файл по установленному макету и запускается
		ТекстБатФайла = СформироватьТекстБатФайлаПоНастройкам();
	Иначе
		ТекстБатФайла = СформироватьТекстБатФайлаПоСтруктуре(СтруктураПараметров);
	КонецЕсли;
	
	Если ПустаяСтрока(ТекстБатФайла) Тогда
		
		СообщитьИнформациюОПростойОшибке("Нельзя создать пустой файл автоматического обновления конфигурации");
		Возврат;
	КонецЕсли;
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент();
	ТекстовыйДокумент.УстановитьТекст(ТекстБатФайла);
	
	ИмяБАТФайла = РаботаСФайлами.ПолучитьИмяФайла(КаталогВременныхФайлов(), "Upd1C.bat");

	ТекстовыйДокумент.Записать(ИмяБАТФайла, КодировкаТекста.OEM);
		
	Если ЗапускатьФайлОбновленияКонфигурации Тогда
						
		Сообщить("Файл для автоматического изменения конфигурации запущен на исполнение: " + ИмяБАТФайла);
				
		// запускаем БАТ файл перезагрузки
		WshShell =  Новый COMОбъект("WScript.Shell"); 
		WshShell.Run("""" + ИмяБАТФайла + """", 0);
		
		ЗавершитьРаботуСистемы(Ложь);
        		
	Иначе
		
		Сообщить("Файл для автоматического изменения конфигурации: " + ИмяБАТФайла);
		// открываем каталог с файлом перезагрузки
		ЗапуститьПриложение(КаталогВременныхФайлов());
		
	КонецЕсли;
	  
КонецПроцедуры

// Процедура показывает форму списка справочника "Настройки обменов" для узла обмена
Процедура ПоказатьНастройкиОбменовДляУзла(УзелОбмена, Владелец = Неопределено) Экспорт
	
	ФормаСписка = Справочники.НастройкиОбменаДанными.ПолучитьФормуСписка(, Владелец);
	
	ФормаСписка.СправочникСписок.Отбор.УзелИнформационнойБазы.Значение = УзелОбмена;
	ФормаСписка.СправочникСписок.Отбор.УзелИнформационнойБазы.ВидСравнения = ВидСравнения.Равно;
	ФормаСписка.СправочникСписок.Отбор.УзелИнформационнойБазы.Использование = Истина;
	
	ФормаСписка.Открыть();
	
КонецПроцедуры

#КонецЕсли


///////////////////////////////////////////////////////////////////////////////
//	ПРОТОКОЛ

// Процедура дописывает информацию в файл лога
Процедура ДобавитьИнформациюВПротокол(Знач ИнформацияДляПользователя, ДанныеПротокола = "", 
			Знач ОтобразитьВОкнеСообщений = Ложь, Знач ЭтоОшибка = Ложь) Экспорт
	
	Если Не ПустаяСтрока(ИнформацияДляПользователя) Тогда
		
		Попытка
			
			Если НЕ ЗначениеЗаполнено(ПараметрыСеанса.ТекущийПользователь) Тогда
				ИмяПользователя = "";
			Иначе
				ИмяПользователя = "[" + Строка(ПараметрыСеанса.ТекущийПользователь) + "] "; 	
			КонецЕсли;
			
		Исключение
			
			ИмяПользователя = "[Сервер]";
			
		КонецПопытки;
			
		СтрокаДляЗаписи = "[" + Строка(ТекущаяДата()) + "] " + ИмяПользователя + ИнформацияДляПользователя;
	Иначе
		// записываем строку как есть
		СтрокаДляЗаписи = ИнформацияДляПользователя;
	КонецЕсли;
		
	Если ДанныеПротокола = "" Тогда
		ДанныеПротокола = СтрокаДляЗаписи;
	Иначе
		ДанныеПротокола = ДанныеПротокола + Символы.ПС + СтрокаДляЗаписи;	
	КонецЕсли;	

	// возможно информацию еще надо в окно сообщений пользователю вывести
	#Если Клиент Тогда
		
		Если ОтобразитьВОкнеСообщений Тогда
			
			Если ЭтоОшибка Тогда
				СообщитьОбОшибке(ИнформацияДляПользователя);
			Иначе
				
				Если ИнформацияДляПользователя <> Символы.ПС Тогда 
					ИнформацияДляПользователя = СформироватьТекстСообщения(ИнформацияДляПользователя);
				КонецЕсли;	
				
				Сообщить(ИнформацияДляПользователя);
			КонецЕсли;
			
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

// Процедура отображает сообщение пользователю и записывает его в лог
Процедура СообщитьПростуюИнформацию(Знач ИнформацияДляПользователя, ДанныеПротокола, Знач ВывестиИнформациюВОкноСообщений = Истина) Экспорт
	
	ДобавитьИнформациюВПротокол(ИнформацияДляПользователя, ДанныеПротокола, ВывестиИнформациюВОкноСообщений, Ложь);
	
КонецПроцедуры

// Процедура отображает сообщение об ошибке пользователю и записывает его в лог
Процедура СообщитьИнформациюОПростойОшибке(Знач ИнформацияДляПользователя, ДанныеПротокола = "", Знач ОтображатьСообщениеОбОшибке = Истина) Экспорт
	
	ДобавитьИнформациюВПротокол(ИнформацияДляПользователя, ДанныеПротокола, ОтображатьСообщениеОбОшибке, Истина);
	
КонецПроцедуры
  
// функция отражает сообщение об ошибке при обмене данными
Процедура СообщитьИнформациюОбОшибкеОбмена(Знач ИнформацияДляПользователя, СтруктураОбменаДанными) Экспорт
	
	ДобавитьИнформациюВПротокол(ИнформацияДляПользователя, СтруктураОбменаДанными.ДанныеПротокола, СтруктураОбменаДанными.ВывестиИнформациюОбОшибкеВОкноСообщений, Истина);
	
КонецПроцедуры

// Процедура отображает сообщение пользователю и записывает его в лог
Процедура СообщитьИнформациюОбОбмене(Знач ИнформацияДляПользователя, СтруктураОбменаДанными) Экспорт
	
	ДобавитьИнформациюВПротокол(ИнформацияДляПользователя, СтруктураОбменаДанными.ДанныеПротокола, СтруктураОбменаДанными.ВывестиИнформациюВОкноСообщений, Ложь);
	
КонецПроцедуры

// Процедура записывает данные протокола
Процедура ЗаписатьДанныеПротокола(НастройкаОбмена, ДанныеПротокола, ЭтоОшибка = Ложь)
	
	// только пустую строку не записываем, все остальное пишем
	Если ДанныеПротокола = "" Тогда
		Возврат;
	КонецЕсли;
	
	Если НастройкаОбмена.ВестиЛог Тогда
		
		ТипСообщения = ?(ЭтоОшибка, УровеньЖурналаРегистрации.Ошибка, УровеньЖурналаРегистрации.Информация);
		
		ЗарегистрироватьСобытие("ОбменДанными."+ Строка(НастройкаОбмена.Ссылка), ТипСообщения, , НастройкаОбмена.Ссылка, СокрЛП(ДанныеПротокола));
			
	КонецЕсли;
	
	// очищаем данные протокола обмена
	ДанныеПротокола = "";
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// РАБОТА С ФАЙЛАМИ ОБМЕНА

// функция по двум узлам возвращает имя самого файла обмена информацией, без пути к файлам
Функция СформироватьИмяФайлаОбменаМеждуУзлами(УзелОтправитель, УзелПолучатель, Знач РасширениеФайла = ".xml")
	
	Возврат "Message_" + СокрЛП(УзелОтправитель.Код) + "_" + СокрЛП(УзелПолучатель.Код) + РасширениеФайла;
	
КонецФункции

// Процедура по полному пути к файлу определяет каталог файла и если каталог отсутствует то создает его
Процедура СоздатьКаталогПоПолномуПутиКФайлу(Знач ПолноеИмяФайла)
	
	ИмяКаталога = "";
	ИмяФайла = "";
	
	РаботаСФайлами.ПолучитьКаталогИИмяФайла(ПолноеИмяФайла, ИмяКаталога, ИмяФайла);
	
	СоздатьКаталогВСлучаеОтсутствия(ИмяКаталога);
	
КонецПроцедуры

// Процедура создает каталог если его нет
Процедура СоздатьКаталогВСлучаеОтсутствия(Знач ИмяКаталога)
	
	// ищем нужный нам каталог, если его нет - то пытаемся создать
	НаличиеКаталогаОбмена = ПроверитьНаличиеКаталога(ИмяКаталога, Истина);
	
	Если НЕ НаличиеКаталогаОбмена Тогда
		// создаем вложенный каталог в темповый
		СоздатьКаталог(ИмяКаталога);
	КонецЕсли;
	
КонецПроцедуры

// функция возвращает каталог для временных файлов при обмене данными
Функция ПолучитьПутьККаталогуВременныхФайловОбмена(Знач НаименованиеНастройкиОбмена, УзелОбмена, Знач ПроверятьНаличиеКаталога = Ложь)
	
	// во временном каталоге каталог с именем узла, а потом с именем настройки обмена...
	
	ИмяПланаОбмена = ПолучитьИмяПланаОбмена(УзелОбмена);
	ИмяПланаОбмена = РаботаСФайлами.УдалитьЗапрещенныеСимволыИмени(ИмяПланаОбмена);
	
	ПутьКФайлуОбмена = РаботаСФайлами.ПолучитьИмяФайла(КаталогВременныхФайлов(), ИмяПланаОбмена);
	
	СтрокаКаталогаОбмена = РаботаСФайлами.УдалитьЗапрещенныеСимволыИмени(НаименованиеНастройкиОбмена);
	ПутьКФайлуОбмена = РаботаСФайлами.ПолучитьИмяФайла(ПутьКФайлуОбмена, СтрокаКаталогаОбмена);
		
	Если ПроверятьНаличиеКаталога Тогда
		
		// ищем нужный нам каталог, если его нет - то пытаемся создать
		СоздатьКаталогВСлучаеОтсутствия(ПутьКФайлуОбмена);

	КонецЕсли;

	Возврат ПутьКФайлуОбмена;
	
КонецФункции

// функция возвращает имя файла обмена между двумя узлами
Функция ВернутьПолныйПутьКФайлуОбменаМеждуУзлами(Знач ИмяКаталогаОбмена = "", Знач НаименованиеНастройкиОбмена, УзелОтправитель, УзелПолучатель, 
	Знач ПроверятьНаличиеКаталога = Ложь)
	
	// если узел отправитель и получатель совпадают то обмениваться не с кем
	Если УзелОтправитель = УзелПолучатель Тогда
		Возврат "";
	КонецЕсли;
	
	// имя итогового каталога обмена
	Если ПустаяСтрока(ИмяКаталогаОбмена) Тогда
		
		ПутьКФайлуОбмена = ПолучитьПутьККаталогуВременныхФайловОбмена(НаименованиеНастройкиОбмена, УзелОтправитель, ПроверятьНаличиеКаталога);
		
	Иначе
		
		ПутьКФайлуОбмена = ИмяКаталогаОбмена;
		Если ПроверятьНаличиеКаталога Тогда
		
			// ищем нужный нам каталог, если его нет - то пытаемся создать
			СоздатьКаталогВСлучаеОтсутствия(ПутьКФайлуОбмена);

		КонецЕсли;
		
	КонецЕсли;
			
	// Формируем имя временного файла
	ИмяФайла = РаботаСФайлами.ПолучитьИмяФайла(ПутьКФайлуОбмена, СформироватьИмяФайлаОбменаМеждуУзлами(УзелОтправитель, УзелПолучатель, ".xml"));
	
	Возврат ИмяФайла;
	
КонецФункции

// функция возвращает полный путь для создания временного файла обмена данными для записи изменений
Функция ВернутьИмяВременногоФайлаЗаписиДанных(СтруктураНастроекОбменаДанными)
	
	УзелОбмена = СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы;
	
	ИмяФайла = ВернутьПолныйПутьКФайлуОбменаМеждуУзлами(, СтруктураНастроекОбменаДанными.ДанныеНастройки.Наименование,
		ПолучитьТекущийУзелИБ(УзелОбмена), УзелОбмена, Истина);
		
	Возврат ИмяФайла;
	
КонецФункции

// функция возвращает полный путь временного файла для чтения изменений 
Функция ВернутьИмяВременногоФайлаЧтенияДанных(СтруктураНастроекОбменаДанными, Знач ИзменитьРасширениеФайлаНаZip)
	
	УзелОбмена = СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы;
	
	ИмяФайла = ВернутьПолныйПутьКФайлуОбменаМеждуУзлами(, СтруктураНастроекОбменаДанными.ДанныеНастройки.Наименование, УзелОбмена, ПолучитьТекущийУзелИБ(УзелОбмена));
	
	// для файла чтения данных важно что бы существовал каталог, откуда будем читать данные
	
	ПроверитьДоступностьРаботыСКаталогом(ИмяФайла, ИзменитьРасширениеФайлаНаZip);
	
	Возврат ИмяФайла;
	
КонецФункции

// функция проверяет наличие не пустого файла
функция ПроверитьНаличиеФайлаОбмена(Знач ИмяФайлаОбмена)
	
	// проверка наличия файла
	Файл = Новый Файл(ИмяФайлаОбмена);
	Если Не Файл.Существует() Тогда
		Возврат Ложь;
	КонецЕсли;
		
	Если Файл.ЭтоКаталог() ИЛИ Файл.Размер() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// функция проверяет наличие каталога обмена
Функция ПроверитьНаличиеКаталога(Знач ИмяКаталога, Знач ПроверятьЧтоНайденныйФайлЭтоКаталог = Ложь) Экспорт
	
	// ищем нужный нам каталог, если его нет - то пытаемся создать
	Если ПустаяСтрока(ИмяКаталога) Тогда 
		Возврат Ложь;
	КонецЕсли;
	
	ВыбФайл = Новый Файл(ИмяКаталога);
	Если Не ВыбФайл.Существует() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПроверятьЧтоНайденныйФайлЭтоКаталог Тогда
		// проверка что это точно каталог
		Возврат ВыбФайл.ЭтоКаталог();
	Иначе
		// если без разницы каталог это или нет
		Возврат Истина;
	КонецЕсли;
	
КонецФункции


///////////////////////////////////////////////////////////////////////////////
// ЧТЕНИЕ И ЗАПИСЬ СООБЩЕНИЙ С ИЗМЕНЕНИЯМИ

// функция создает XMLЗапись для обмена данными
Функция СоздатьXMLЗаписьДляОбменаДанными(УзелОбмена, Знач ИмяФайлаОбменаДанными)
	
	Если ПустаяСтрока(ИмяФайлаОбменаДанными) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Создаем объект записи XML
	ЗаписьXML = Новый ЗаписьXML;
	
	Попытка
		ЗаписьXML.ОткрытьФайл(ИмяФайлаОбменаДанными);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат ЗаписьXML;
	
КонецФункции

// функция создает XML чтение по узлу обмена
Функция СоздатьXMLЧтениеДляОбменаДанными(УзелОбмена, Знач ИмяФайлаОбменаДанными)
	
	НаличиеФайлаОбмена = ПроверитьНаличиеФайлаОбмена(ИмяФайлаОбменаДанными);
	Если Не НаличиеФайлаОбмена Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Производим попытку открытия файла
	ЧтениеXML = Новый ЧтениеXML;
	Попытка
		ЧтениеXML.ОткрытьФайл(ИмяФайлаОбменаДанными);
		Возврат ЧтениеXML;
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Процедура записывает изменения узла информационной база в файл в темповом каталоге
Процедура ЗаписатьСообщенияСИзменениямиДляУзла(СтруктураНастроекОбменаДанными, Знач ИмяФайлаОбменаДанными)

	УзелОбмена = СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы;
	
	СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;
 	
	Попытка
				
		ЭтоРИБ = ОпределитьПоУзлуОбменаЭтоРИБ(УзелОбмена); 
		
		ЗаписьXML = СоздатьXMLЗаписьДляОбменаДанными(УзелОбмена, ИмяФайлаОбменаДанными);
		Если ЗаписьXML = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		#Если Клиент Тогда
			//Состояние("Запись изменений для узла """ + УзелОбмена.Наименование + """ ...");
		#КонецЕсли
	
		ДобавитьИнформациюВПротокол("Начало записи изменений в файл обмена " + ИмяФайлаОбменаДанными, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		
		Если ЭтоРИБ Тогда
			
			// Создаем новое сообщение
			ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();

			ЗаписьСообщения.НачатьЗапись(ЗаписьXML, УзелОбмена);
			
			// для РИБ изменения в информационной базе
			ПланыОбмена.ЗаписатьИзменения(ЗаписьСообщения, СтруктураНастроекОбменаДанными.ДанныеНастройки.КоличествоЭлементовВТранзакцииНаВыгрузкуДанных);
			
			// Завершаем запись сообщения
			ЗаписьСообщения.ЗакончитьЗапись();
				
			ЗаписьXML.Закрыть();
			
			СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Истина;
		Иначе
			
			ЭтотУзелОбмена = ПолучитьТекущийУзелИБ(УзелОбмена).ПолучитьОбъект();
						
			// план обмена самостоятельно читает изменения от узла
			СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = ЭтотУзелОбмена.ВыгрузитьИзмененияДанныхДляУзла(УзелОбмена, 
				СтруктураНастроекОбменаДанными.ДанныеНастройки.КоличествоЭлементовВТранзакцииНаВыгрузкуДанных, ЗаписьXML);
			
		КонецЕсли;
		
		ДобавитьИнформациюВПротокол("Окончание записи изменений в файл обмена " + ИмяФайлаОбменаДанными, СтруктураНастроекОбменаДанными.ДанныеПротокола);
				
	Исключение
		
		// в режиме клиента выводим информацию об ошибке
		СообщитьИнформациюОбОшибкеОбмена("Ошибка при записи изменений при обмене: " + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);
		СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;
		
	КонецПопытки;
	
КонецПроцедуры

// Процедура читает файл изменений от узла РИБ
Процедура ЗагрузитьCообщениеСИзменениямиОтРИБУзла(СтруктураНастроекОбменаДанными, ЧтениеXML)
	
	СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Истина;

	// Загрузка из найденного файла
	ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
	
	ЧтениеСообщения.НачатьЧтение(ЧтениеXML);

	Попытка
		
		ПланыОбмена.ПрочитатьИзменения(ЧтениеСообщения, СтруктураНастроекОбменаДанными.ДанныеНастройки.КоличествоЭлементовВТранзакцииНаЗагрузкуДанных);
		
		ЧтениеСообщения.ЗакончитьЧтение();
		ЧтениеXML.Закрыть();
		
	Исключение
		
		СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Ложь;
		СообщитьИнформациюОбОшибкеОбмена("Ошибка при чтении изменений при обмене РИБ: " + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);
		Возврат;
                        
	КонецПопытки;
	
КонецПроцедуры

// Процедура получения сообщения обмена данными
// Получает сообщение с новыми данными для этого узла и загружает данные
//
Процедура ЗагрузитьСообщениеСИзменениямиДляУзла(СтруктураНастроекОбменаДанными, Знач ИмяФайлаОбменаДанными)
			
	СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Ложь;

	УзелОбмена = СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы;
		
	ЭтоРИБ = ОпределитьПоУзлуОбменаЭтоРИБ(УзелОбмена);

	Попытка
        					
		ЧтениеXML = СоздатьXMLЧтениеДляОбменаДанными(УзелОбмена, ИмяФайлаОбменаДанными);
		
		Если ЧтениеXML = Неопределено Тогда
			// не удалось создать объект чтения данных - ничего не делаем
			СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Ложь;
			Возврат;
		КонецЕсли;
		
		#Если Клиент Тогда
			//Состояние("Чтение изменений от узла """ + УзелОбмена.Наименование + """ ...");
		#КонецЕсли
	
		ДобавитьИнформациюВПротокол("Начало чтения изменений из файла обмена " + ИмяФайлаОбменаДанными, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		Если ЭтоРИБ Тогда
			
			ЗагрузитьCообщениеСИзменениямиОтРИБУзла(СтруктураНастроекОбменаДанными, ЧтениеXML);
			            			
		Иначе
			
			ЭтотУзелОбмена = ПолучитьТекущийУзелИБ(УзелОбмена).ПолучитьОбъект();
			// план обмена самостоятельно читает изменения от узла
			СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = ЭтотУзелОбмена.ЗагрузитьИзмененияДанныхДляУзла(УзелОбмена, 
				СтруктураНастроекОбменаДанными.ДанныеНастройки.КоличествоЭлементовВТранзакцииНаЗагрузкуДанных, ЧтениеXML);
			
		КонецЕсли;
		
		ДобавитьИнформациюВПротокол("Окончание чтения изменений из файла обмена " + ИмяФайлаОбменаДанными, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		
	Исключение
		
		СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Ложь;
		
		ОписаниеОшибки = ОписаниеОшибки();
		Если Найти(ОписаниеОшибки, "Номер сообщения меньше или равен номеру ранее принятого сообщения") Тогда
			Сообщить("Данное сообщение уже загружалось.", СтатусСообщения.Информация);
		Иначе
			СообщитьИнформациюОбОшибкеОбмена("Ошибка при чтении изменений из файла обмена." + Символы.ПС + ОписаниеОшибки, СтруктураНастроекОбменаДанными);
		КонецЕсли;
			
	КонецПопытки;
	
КонецПроцедуры

// функция возвращает имя плана обмена по узлу обмена
Функция ПолучитьИмяПланаОбмена(УзелОбмена) Экспорт
	
	Если НЕ ЗначениеЗаполнено(УзелОбмена) Тогда
		Возврат "";
	КонецЕсли;
	
	МетаданныеУзла = УзелОбмена.Метаданные();
	Возврат МетаданныеУзла.Имя;
    	
КонецФункции

// функция возвращает узел текущей ИБ по узлу обмена
Функция ПолучитьТекущийУзелИБ(УзелОбмена) Экспорт
	
	ИмяПланаОбмена = ПолучитьИмяПланаОбмена(УзелОбмена);
	
	Если НЕ ЗначениеЗаполнено(ИмяПланаОбмена) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат ПланыОбмена[ИмяПланаОбмена].ЭтотУзел();
	
КонецФункции

// функция по узлу обмена определяет это база РИБ или нет
Функция ОпределитьПоУзлуОбменаЭтоРИБ(УзелОбмена) Экспорт
	
	Если НЕ ЗначениеЗаполнено(УзелОбмена) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	МетаданныеПланаОбмена = УзелОбмена.Метаданные();
	Возврат МетаданныеПланаОбмена.РаспределеннаяИнформационнаяБаза;
	
КонецФункции


///////////////////////////////////////////////////////////////////////////////
// ВЫБОР КАТАЛОГОВ И ФАЙЛОВ ОБМЕНА ДАННЫМИ

#Если Клиент Тогда

// функция возвращает имя выбранного пользователем файла для обмена информацией
Функция ВыбратьФайлДляОбмена(Знач НачальныйКаталог, Знач ИмяФайлаПоУмолчанию = "") Экспорт
	
	ДиалогВыбора = РаботаСФайлами.ПолучитьДиалогВыбораФайлов(Ложь, НачальныйКаталог);
	ДиалогВыбора.Фильтр						= "Файл данных(*.xml)|*.xml|Архив с данными(*.zip)|*.zip|*.*|*.*";
	ДиалогВыбора.Заголовок 					= "Выбор файла обмена информацией";
	ДиалогВыбора.ПредварительныйПросмотр	= Ложь;
	ДиалогВыбора.Расширение             	= "xml";
	ДиалогВыбора.ИндексФильтра          	= 0;
	
	Если Не ПустаяСтрока(ИмяФайлаПоУмолчанию) Тогда
		ДиалогВыбора.ПолноеИмяФайла 		= ИмяФайлаПоУмолчанию;
	КонецЕсли;
	
	РезультатВыбора = ДиалогВыбора.Выбрать();
	
	Если РезультатВыбора Тогда
		Возврат СокрЛП(ДиалогВыбора.ПолноеИмяФайла);
	Иначе
		Возврат "";
	КонецЕсли;
	
КонецФункции

// функция возвращает выбранный пользователем каталог для выгрузки данных
Функция ВернутьВыбранныйПользователемКаталогДляОбмена(КаталогОбмена = "")
	
	// хотят только изменения выгрузить
	РезультатВыбора = РаботаСФайлами.ВыбратьКаталог(КаталогОбмена, "Выбор каталога обмена данными");
	Если Не РезультатВыбора Тогда
		КаталогОбмена = "";
	Иначе
			
		// надо проверить наличие каталога на диске
		НаличиеКаталога = ПроверитьНаличиеКаталога(КаталогОбмена, Истина);
			
		// выбран каталог которого нет на диске
		Если Не НаличиеКаталога Тогда
				
			КаталогОбмена = "";
				
		КонецЕсли;
			
	КонецЕсли;
	
	Возврат КаталогОбмена;
	
КонецФункции

#КонецЕсли

// Функция запрашивает у пользователя ввести имя файла для обмена данными либо имя каталога для выгрузки данных
Функция ОпроситьИмяКаталогаОбменаДанными(Знач ТекстИнформационногоСообщения = "",
	СтруктураНастроекОбменаДанными, КаталогОбмена)
	
	Если Не ПустаяСтрока(ТекстИнформационногоСообщения) Тогда
		
		СообщитьИнформациюОбОбмене(ТекстИнформационногоСообщения, СтруктураНастроекОбменаДанными);
		
	КонецЕсли;
	
	// не задан каталог обмена данными
	Если НЕ СтруктураНастроекОбменаДанными.РучнойРежимЗапуска Тогда
		Возврат Ложь;
	КонецЕсли;
		
	// запуск в интерактивном режиме
	#Если Клиент Тогда	
							
		КаталогОбмена = ВернутьВыбранныйПользователемКаталогДляОбмена(КаталогОбмена);
	
	#Иначе
		Возврат Ложь;
	#КонецЕсли

	Возврат Истина;
	
КонецФункции


// АРХИВАЦИЯ
///////////////////////////////////////////////////////////////////////////////

// функция архивирует файл
Функция ЗаархивироватьФайл(Знач ИмяИсходногоФайла, СтруктураНастроекОбменаДанными)
	
	Попытка
		ДобавитьИнформациюВПротокол("Начало сжатия файла обмена " + СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, СтруктураНастроекОбменаДанными.ДанныеПротокола);
		
		Архиватор = Новый ЗаписьZipФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, СтруктураНастроекОбменаДанными.ДанныеНастройки.ПарольНаОтправку, "Файл обмена данными");
		Архиватор.Добавить(ИмяИсходногоФайла);
		Архиватор.Записать();
		
		ДобавитьИнформациюВПротокол("Окончание сжатия файла обмена данными " + ИмяИсходногоФайла + "." + Символы.ПС +
			"Данные файла обмена помещены в файл " + СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, СтруктураНастроекОбменаДанными.ДанныеПротокола);
	Исключение
		
		СообщитьИнформациюОбОшибкеОбмена("Ошибка при сжатии данных файла обмена: " + ИмяИсходногоФайла + Символы.ПС + ОписаниеОшибки(), 
			СтруктураНастроекОбменаДанными);
		Возврат Ложь;	
		
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

// функция разархивирует файл
Функция РазархивироватьФайл(СтруктураНастроекОбменаДанными) 
	
	КаталогДляРаспаковки = КаталогВременныхФайлов();
	
	ИмяРазархивированногоФайла = "";
	
	Попытка
		ДобавитьИнформациюВПротокол("Начало распаковки файла обмена данными " + СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений, 
			СтруктураНастроекОбменаДанными.ДанныеПротокола);
		
		Архиватор = Новый ЧтениеZipФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений, СтруктураНастроекОбменаДанными.ДанныеНастройки.ПарольНаПрием);
		
		Если Архиватор.Элементы.Количество() > 0 Тогда
			
			Архиватор.Извлечь(Архиватор.Элементы[0], КаталогДляРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
			ИмяРазархивированногоФайла = РаботаСФайлами.ПолучитьИмяФайла(КаталогДляРаспаковки, Архиватор.Элементы[0].Имя);
			
		Иначе
			
			ИмяРазархивированногоФайла = "";	
			
		КонецЕсли;

		Архиватор.Закрыть();
	
	Исключение
		
		СообщитьИнформациюОбОшибкеОбмена("Ошибка при распаковке данных из архива : " + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);
		Возврат "";
							
	КонецПопытки;
	
	ДобавитьИнформациюВПротокол("Окончание распаковки файла обмена данными " + СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений + ".
		|Распакованные данные помещены в файл " + ИмяРазархивированногоФайла, СтруктураНастроекОбменаДанными.ДанныеПротокола);
	
	Возврат ИмяРазархивированногоФайла;
	
КонецФункции


///////////////////////////////////////////////////////////////////////////////
//	ОБМЕН ИНФОРМАЦИЕЙ

// Процедура производит чтение данных
Процедура ВыполнитьЗагрузкуДанныхИзФайлаОбмена(СтруктураНастроекОбменаДанными)
	
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Загрузка данных из файла обмена", 5);
	
	СтруктураНастроекОбменаДанными.РезультатЧтенияДанных = Ложь;
	
	// ЧТЕНИЕ
	Если НЕ СтруктураНастроекОбменаДанными.ПроизводитьЧтениеДанных Тогда
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Загрузка данных из файла обмена", 40);
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений) Тогда
		
		СообщитьИнформациюОбОбмене("Не найден входящий файл обмена данными.", СтруктураНастроекОбменаДанными);
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Загрузка данных из файла обмена", 40);
		Возврат;
		
	КонецЕсли;
		
	// если расширение файла для чтения ZIP то его нужно сначала разархивировать
	РасширениеФайлаОбмена = РаботаСФайлами.ПолучитьРасширениеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений);
	ЧтениеИзАрхива = Врег(РасширениеФайлаОбмена) = "ZIP";
			
	Если ЧтениеИзАрхива Тогда
		ИмяВременногоФайла = РазархивироватьФайл(СтруктураНастроекОбменаДанными);										
	Иначе
		ИмяВременногоФайла = СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений;				
	КонецЕсли;
			
	// читаем сообщения с изменениями
	Если ИмяВременногоФайла = "" Тогда
		
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Загрузка данных из файла обмена", 40);
		Возврат;
		
	КонецЕсли;
		
	ЗагрузитьСообщениеСИзменениямиДляУзла(СтруктураНастроекОбменаДанными, ИмяВременногоФайла);
					
	// сообщим о результатах чтения данных
	Если СтруктураНастроекОбменаДанными.РезультатЧтенияДанных Тогда

		СообщитьИнформациюОбОбмене("Чтение данных из файла обмена успешно завершено.", СтруктураНастроекОбменаДанными);
								
	Иначе
				
		СообщитьИнформациюОбОшибкеОбмена("Чтение данных из файла обмена завершено с ошибками!", СтруктураНастроекОбменаДанными);
		
		// ДАЛИОНПРО - Начало
		//Если КонфигурацияИзменена() 
		//	И ПараметрыСеанса.ТекущаяИБ.СоздаватьЗадачуОбновленияКонфигурацииБД
		//	И ЗначениеЗаполнено(ПараметрыСеанса.ТекущаяИБ.ИсполнительЗадачиОбновления) Тогда
		//	
		//	Основание = СтруктураНастроекОбменаДанными.ДанныеНастройки.Ссылка;
		//	
		//	ТипЗадачи = "ОбновлениеКонфигурацииБД";
		//	РезультатПроверки = ПроверитьНеобходимостьСоздатьОбновитьЗадачу(ТипЗадачи, Основание);
		//	
		//	Если РезультатПроверки.СформироватьЗадачу Тогда
		//	
		//		РеквизитыДокументаЗадача = СформироватьРеквизитыДокументаЗадача(ТипЗадачи, ПараметрыСеанса.ТекущийТО);
		//					
		//		ИсполняемыйКод ="ПроцедурыОбменаДанными.ОбновитьКонфигурациюБазыДанных(Параметры.НастройкаОбменаДанными);";
		//		
		//		ПредставлениеДействия = "Обновление конфигурации базы данных";
		//		Параметры = Новый Структура;
		//		Параметры.Вставить("НастройкаОбменаДанными", Основание);
		//		
		//		СоздатьОбновитьЗадачу(РезультатПроверки.ЗадачаСсылка, Основание, РеквизитыДокументаЗадача, ИсполняемыйКод, ПредставлениеДействия, Параметры);
		//		
		//	КонецЕсли;
		//	
		//КонецЕсли;
		// ДАЛИОНПРО - Конец
		
	КонецЕсли;
			
	// временный файл откуда считывались данные в любом случае не нужен	
	Если ЧтениеИзАрхива Тогда
				
		ВыполнитьУдалениеФайла(ИмяВременногоФайла, СтруктураНастроекОбменаДанными);	
				
	КонецЕсли;
	
	// ДАЛИОНПРО - Начало	
	//Если ЗначениеЗаполнено(ПараметрыСеанса.ТекущийПользователь) И ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ИспользоватьНапоминания") Тогда
	//	КонтрольНапоминаний();
	//КонецЕсли;
	// ДАЛИОНПРО - Конец

	// запоминаем последнюю дату чтения данных
	СтруктураНастроекОбменаДанными.ДатаПоследнейЗагрузки = ТекущаяДата();
	
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Загрузка данных из файла обмена", 40);
	
КонецПроцедуры

// Процедура производит запись данных
Процедура ВыполнитьВыгрузкуДанныхВФайлОбмена(СтруктураНастроекОбменаДанными)
	
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных в файл обмена", 5);
	
	СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;
		
	Если  СтруктураНастроекОбменаДанными.ПроизводитьЧтениеДанных 
		И СтруктураНастроекОбменаДанными.ПроизводитьОтправкуСообщенийПриУспешномПриеме 
		И НЕ СтруктураНастроекОбменаДанными.РезультатЧтенияДанных 
		И СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы.НомерОтправленного <> 0 Тогда
		
		Запрос = Новый Запрос;		
		Запрос.УстановитьПараметр("Ссылка", СтруктураНастроекОбменаДанными.ДанныеНастройки.Ссылка);
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПараметрыОбменаДанными.РезультатПоследнейВыгрузки
		|ИЗ
		|	РегистрСведений.ПараметрыОбменаДанными КАК ПараметрыОбменаДанными
		|ГДЕ
		|	ПараметрыОбменаДанными.НастройкаОбменаДанными.Ссылка = &Ссылка";
		
		Выборка = Запрос.Выполнить().Выбрать();		
		РезультатПоследнейВыгрузки = Истина;
		
		Если Выборка.Следующий() Тогда
			РезультатПоследнейВыгрузки = Выборка.РезультатПоследнейВыгрузки;
		КонецЕсли;
		
		Если РезультатПоследнейВыгрузки Тогда		
			
			СообщитьИнформациюОбОбмене("Данные не выгружены, по причине неуспешного чтения данных из файла обмена!", СтруктураНастроекОбменаДанными);
			ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных из файла обмена", 40);
			Возврат;
			
		КонецЕсли;
		
	КонецЕсли;
			
	// ЗАПИСЬ
	Если Не СтруктураНастроекОбменаДанными.ПроизводитьЗаписьДанных Тогда
		
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных в файл обмена", 40);
		Возврат;
		
	КонецЕсли;
		
	Если ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений) Тогда
		
		СообщитьИнформациюОбОбмене("Выгрузка изменений из текущей информационной базы НЕ произведена!", СтруктураНастроекОбменаДанными);
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных в файл обмена", 40);
		Возврат;
		
	КонецЕсли;
	          	
	Если ПланыОбмена.ГлавныйУзел() <> Неопределено И КонфигурацияИзменена() Тогда
		
		ТекстИнформация = "Выгрузка изменений из текущей информационной базы НЕ произведена!
		|Конфигурация базы данных отличается от основной конфигурации.";
		
		СообщитьИнформациюОбОбмене(ТекстИнформация, СтруктураНастроекОбменаДанными);
		ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных из файла обмена", 40);
		Возврат;          
		
	КонецЕсли;
	
	// если идет архивирование файла, то надо сначала в темповый файл записать изменения а потом их заархивировать
	Если СтруктураНастроекОбменаДанными.ДанныеНастройки.ВыполнятьАрхивациюФайловОбмена Тогда
		ИмяФайлаДляЗаписиИзменений = ПолучитьИмяВременногоФайла(".xml");				
	Иначе
		ИмяФайлаДляЗаписиИзменений = СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений;				
	КонецЕсли;
	
	// записываем изменения
	ЗаписатьСообщенияСИзменениямиДляУзла(СтруктураНастроекОбменаДанными, ИмяФайлаДляЗаписиИзменений);
			
	// если надо то архивируем
	Если СтруктураНастроекОбменаДанными.РезультатЗаписиДанных
		И СтруктураНастроекОбменаДанными.ДанныеНастройки.ВыполнятьАрхивациюФайловОбмена Тогда
				
		СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = ЗаархивироватьФайл(ИмяФайлаДляЗаписиИзменений, СтруктураНастроекОбменаДанными);
		
		Если СтруктураНастроекОбменаДанными.РезультатЗаписиДанных Тогда 
			
			// грохаем временный файл
			ВыполнитьУдалениеФайла(ИмяФайлаДляЗаписиИзменений, СтруктураНастроекОбменаДанными);
			
		КонецЕсли;
								
	КонецЕсли;
			
	// сообщим о результатах чтения данных
	Если СтруктураНастроекОбменаДанными.РезультатЗаписиДанных Тогда
					
		СообщитьИнформациюОбОбмене("Запись изменений текущей информационной базы в файл обмена завершилась успешно.", СтруктураНастроекОбменаДанными);
								
	Иначе
					
		СообщитьИнформациюОбОшибкеОбмена("Запись изменений текущей информационной базы в файл обмена завершилась с ошибками!", СтруктураНастроекОбменаДанными);
					
	КонецЕсли;
					
	СтруктураНастроекОбменаДанными.ДатаПоследнейВыгрузки = ТекущаяДата();
	
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Выгрузка данных в файл обмена", 40);
	
КонецПроцедуры

// функция возвращает дату файла последнего обмена для настройки обмена
Функция ПолучитьДатуФайлаПоследнейЗагрузкиДанных(СсылкаНастройкиОбмена)
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПараметрыОбменаДанными.ДатаПоследнегоФайлаОбмена
				   |ИЗ
	               |	РегистрСведений.ПараметрыОбменаДанными КАК ПараметрыОбменаДанными
				   |	ГДЕ (ПараметрыОбменаДанными.НастройкаОбменаДанными = &Ссылка)";
				   
	Запрос.УстановитьПараметр("Ссылка", СсылкаНастройкиОбмена); 
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ДатаПоследнегоФайлаОбмена;
	Иначе
		Возврат Неопределено;		
	КонецЕсли;
	
КонецФункции

// Процедура по адресу FTP обмена получает имя сервера и имя каталога обмена
Процедура ПолучитьИмяСервераИИмяКаталогаОбмена(Знач ПолныйFTPАдрес, ИмяСервера, ИмяКаталога)
	
	АдресОбмена = НормализоватьFTPАдрес(ПолныйFTPАдрес);
	
	// принцип получения адреса такой, все что до первой черты / или \ - это имя сервера, потом каталог
	АдресОбмена = СтрЗаменить(АдресОбмена, "\", "/");
	
	ПозицияПрямогоСлеша = Найти(АдресОбмена, "/");
	
	Если ПозицияПрямогоСлеша = 0 Тогда
		
		ИмяСервера = АдресОбмена;
		ИмяКаталога = "";
		
		
	Иначе
		
		ИмяСервера = Сред(АдресОбмена, 1, ПозицияПрямогоСлеша - 1);
		ИмяКаталога = Сред(АдресОбмена, ПозицияПрямогоСлеша);
		
		// последний должен быть слеш у имени каталога
		Если Сред(ИмяКаталога, СтрДлина(ИмяКаталога)) <> "/" Тогда
			
			ИмяКаталога = ИмяКаталога + "/";
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// функция выполняет FTP подключение к серверу
Функция ВыполнитьFTPПодключениеКСерверу(Знач ИмяFTPСервера, НастройкиОбмена, 
	ДанныеПротокола = "", Знач ВывестиИнформациюВОкноСообщений = Истина)       
	
	Перем Соединение;
	
	#Если Клиент Тогда
		//Состояние("Выполняется подключение к FTP: " + ИмяFTPСервера);
	#КонецЕсли
    
	Попытка
		
		// если есть пользователь прокси сервера, то подключаемся через прокси
		Если Не ПустаяСтрока(НастройкиОбмена.ПользовательПроксиFTP)
			ИЛИ НЕ ПустаяСтрока(НастройкиОбмена.ПротоколПроксиFTP)
			ИЛИ НЕ ПустаяСтрока(НастройкиОбмена.СерверПроксиFTP) Тогда
			
			ИмяПротокола = Врег(СокрЛП(НастройкиОбмена.ПротоколПроксиFTP));
			Если ИмяПротокола <> "" Тогда
				
				Если НЕ (ИмяПротокола = "HTTP" ИЛИ ИмяПротокола = "HTTPS" ИЛИ ИмяПротокола = "FTP") Тогда
					
					СообщитьПростуюИнформацию("Указан не допустимый для использования протокол. 
						|Допустимые для использования протоколы прокси-сервера: http, https и ftp.", 
						ДанныеПротокола, ВывестиИнформациюВОкноСообщений);
					Возврат Неопределено;
						
				КонецЕсли;
				
			КонецЕсли;			
			
			ПроксиСервер = Новый ИнтернетПрокси;
			ПроксиСервер.Пользователь = НастройкиОбмена.ПользовательПроксиFTP;
			ПроксиСервер.Пароль = НастройкиОбмена.ПарольПроксиFTP;
			
			ПроксиСервер.Установить(НастройкиОбмена.ПротоколПроксиFTP, НастройкиОбмена.СерверПроксиFTP, НастройкиОбмена.ПортПроксиFTP);
			
			// Для совместимости со старой платформой
			СистемнаяИнформация = Новый СистемнаяИнформация;
			ВерсияСтрокой = СистемнаяИнформация.ВерсияПриложения;
			ВерсияСтрокой = СтрЗаменить(ВерсияСтрокой, ".", Символы.ПС);
			ВерсияРелиза  = Число(СтрПолучитьСтроку(ВерсияСтрокой, 2));
			НомерРелиза    = Число(СтрПолучитьСтроку(ВерсияСтрокой, 3));
			
			Если ВерсияРелиза = 1 И НомерРелиза < 13 Тогда
				Выполнить("Соединение = Новый FTPСоединение(ИмяFTPСервера, НастройкиОбмена.ПортFTPСоединения, НастройкиОбмена.ПользовательFTPСоединения, НастройкиОбмена.ПарольFTPСоединения, ПроксиСервер, НастройкиОбмена.ПассивноеFTPСоединение);");
			Иначе
				Выполнить("Соединение = Новый FTPСоединение(ИмяFTPСервера, НастройкиОбмена.ПортFTPСоединения, НастройкиОбмена.ПользовательFTPСоединения, НастройкиОбмена.ПарольFTPСоединения, ПроксиСервер, НастройкиОбмена.ПассивноеFTPСоединение, НастройкиОбмена.Таймаут);");
			КонецЕсли;
			
		Иначе
			
			// Для совместимости со старой платформой
			СистемнаяИнформация = Новый СистемнаяИнформация;
			ВерсияСтрокой = СистемнаяИнформация.ВерсияПриложения;
			ВерсияСтрокой = СтрЗаменить(ВерсияСтрокой, ".", Символы.ПС);
			ВерсияРелиза  = Число(СтрПолучитьСтроку(ВерсияСтрокой, 2));
			НомерРелиза    = Число(СтрПолучитьСтроку(ВерсияСтрокой, 3));
			
			Если ВерсияРелиза = 1 И НомерРелиза < 13 Тогда
				Выполнить("Соединение = Новый FTPСоединение(ИмяFTPСервера, НастройкиОбмена.ПортFTPСоединения, НастройкиОбмена.ПользовательFTPСоединения, НастройкиОбмена.ПарольFTPСоединения, , НастройкиОбмена.ПассивноеFTPСоединение);");
			Иначе
				Выполнить("Соединение = Новый FTPСоединение(ИмяFTPСервера, НастройкиОбмена.ПортFTPСоединения, НастройкиОбмена.ПользовательFTPСоединения, НастройкиОбмена.ПарольFTPСоединения, , НастройкиОбмена.ПассивноеFTPСоединение, НастройкиОбмена.Таймаут);");
			КонецЕсли;
									
		КонецЕсли;			
			
	Исключение
			
		// ошибка при подключении к ftp
		СообщитьПростуюИнформацию("Ошибка при подключении к FTP : " + ИмяFTPСервера + " ! " + ОписаниеОшибки(), 
			ДанныеПротокола, ВывестиИнформациюВОкноСообщений);
		Возврат Неопределено;
		
	КонецПопытки;
	
	Возврат Соединение;
	
КонецФункции

// функция проверяет наличие каталога на FTP сервере
Функция ПроверитьНаличиеКаталогаНаFTPСервере(Соединение, Знач ИмяКаталогаСервера, 
	ДанныеПротокола = "", Знач ВывестиИнформациюВОкноСообщений = Истина)
	
	Если ПустаяСтрока(ИмяКаталогаСервера) Тогда
		Возврат Истина;
	КонецЕсли;
	
	//надо сначала проверить что сам каталог доступа есть
	МассивНайденныхКаталогов = Соединение.НайтиФайлы(ИмяКаталогаСервера, "");
	Для Каждого НайденныйКаталог Из МассивНайденныхКаталогов Цикл
		
		// если не каталог - то дальше ищем
		Если НЕ НайденныйКаталог.ЭтоКаталог() Тогда
			Продолжить;
		КонецЕсли;
		
		// большие и маленькие буквы считаются различными
		Если НайденныйКаталог.ПолноеИмя + "/" <> ИмяКаталогаСервера Тогда
			Продолжить;
		КонецЕсли;
		
		Возврат Истина;
		
	КонецЦикла;
	
	// если не найден каталог для обмена
	СообщитьПростуюИнформацию("Не найден FTP каталог обмена информацией: " + ИмяКаталогаСервера, 
		ДанныеПротокола, ВывестиИнформациюВОкноСообщений);
		
	Возврат Ложь;
	
КонецФункции

// функция проверяет настройки FTP подключения
Функция ПроверитьНастройкиFTPПодключения(ДанныеНастройки, ДанныеПротокола = "", Знач ВывестиИнформациюВОкноСообщений = Истина,
	ИмяКаталогаСервера = "", ИмяFTPСервера = "" , Соединение = Неопределено) Экспорт
	
	// нужно по полному имени получить имя сервера и имя каталога
	ПолучитьИмяСервераИИмяКаталогаОбмена(ДанныеНастройки.FTPАдресОбмена, ИмяFTPСервера, ИмяКаталогаСервера);
	
	// если не задано имя сервера или каталога то невозможно обмениваться данными
	Если ПустаяСтрока(ИмяFTPСервера) Тогда
		
		СообщитьПростуюИнформацию("Не задан сервер обмена информацией через FTP: " + ДанныеНастройки.FTPАдресОбмена, 
			ДанныеПротокола, ВывестиИнформациюВОкноСообщений);

		Возврат Ложь;
		
	КонецЕсли;
	
	// соединение
	Соединение = ВыполнитьFTPПодключениеКСерверу(ИмяFTPСервера, ДанныеНастройки, ДанныеПротокола, ВывестиИнформациюВОкноСообщений);
	Если Соединение = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// каталог проверяем
	НаличиеКаталога = ПроверитьНаличиеКаталогаНаFTPСервере(Соединение, ИмяКаталогаСервера, ДанныеПротокола, ВывестиИнформациюВОкноСообщений);
	Если Не НаличиеКаталога Тогда 
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции


// СЛУЖЕБНЫЕ ФУНКЦИЯ ВЫПОЛНЯЮЩИЕСЯ ПЕРЕД ОБМЕНОМ
///////////////////////////////////////////////////////////////////////////////

// Процедура подготавливает обмен через файловый ресурс по настройке обмена данными
Процедура ПодготовитьОбменЧерезФайловыйРесурс(СтруктураНастроекОбменаДанными)
	
	//Алгоритм получения файлов обмена:

	//Случай автоматического запуска обмена:
	//•	Проверка доступности указанного в настройках каталога. Если каталог не доступен (не найден), то обмен не начинается
	//•	Проверка наличия файла обмена от узла информационной базы
	//•	После внесений изменений в информационную базу файл обмена удаляется

	//Случай запуска обмена в ручном режиме:
	//•	Проверка доступности указанного в настройках каталога. 
	//o	Если искомый каталог доступен и файл обмена в нем присутствует, то обмен происходит точно так же как и при 
	//  автоматическом запуске
	//o	Если каталог не доступен или не найден, либо не найден файл обмена данными то пользователю выдается 
	//  соответствующее сообщение. Предлагается выбрать файл для обмена самостоятельно.
	
	ИтоговоеИмяФайлаОбменаДанными = "";
	СтруктураНастроекОбменаДанными.КаталогПроведенияОбменаДанными = "";
	
	КаталогОбменаДанными = СтруктураНастроекОбменаДанными.ДанныеНастройки.КаталогОбменаИнформацией;
	
	ПроверкаНаличияКаталога = ПроверитьНаличиеКаталога(КаталогОбменаДанными, Истина);
	Если НЕ ПроверкаНаличияКаталога Тогда
		
		// не задан каталог обмена данными
		Если ПустаяСтрока(КаталогОбменаДанными) Тогда
			ТекстСообщенияПользователю = "Не задан каталог обмена информацией";
		Иначе
			ТекстСообщенияПользователю = "Не найден каталог обмена информацией: " + КаталогОбменаДанными;
		КонецЕсли;
			
		РезультатВыбора = ОпроситьИмяКаталогаОбменаДанными(ТекстСообщенияПользователю, СтруктураНастроекОбменаДанными, 
			КаталогОбменаДанными);
			
		Если Не РезультатВыбора Тогда
			Возврат;
		КонецЕсли;
	
	КонецЕсли;	
		
	// каталог есть, поверяем наличие файла обмена, если нужно данные считать
	Если СтруктураНастроекОбменаДанными.ПроизводитьЧтениеДанных Тогда
		
		ИмяФайлаШаблонаОбмена = СформироватьИмяФайлаОбменаМеждуУзлами(СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы, СтруктураНастроекОбменаДанными.ТекущийУзелПланаОбмена, "");
		ИмяФайлаПоУмолчаниюXML = ИмяФайлаШаблонаОбмена + ".xml";
		ИмяФайлаПоУмолчаниюZIP = ИмяФайлаШаблонаОбмена + ".zip";
		
		ИтоговоеИмяФайлаОбменаДаннымиXML = РаботаСФайлами.ПолучитьИмяФайла(КаталогОбменаДанными, ИмяФайлаПоУмолчаниюXML);
		НаличиеФайлаОбменаXML = ПроверитьНаличиеФайлаОбмена(ИтоговоеИмяФайлаОбменаДаннымиXML);
				
		ИтоговоеИмяФайлаОбменаДаннымиZIP = РаботаСФайлами.ПолучитьИмяФайла(КаталогОбменаДанными, ИмяФайлаПоУмолчаниюZIP);
		НаличиеФайлаОбменаZIP = ПроверитьНаличиеФайлаОбмена(ИтоговоеИмяФайлаОбменаДаннымиZIP);
				
		Если НЕ НаличиеФайлаОбменаXML И НЕ НаличиеФайлаОбменаZIP Тогда
				
			// каталог есть, но файлов в нем, удовлетворяющих условиям поиска нет
			// значит просто файл не нашли, вот и все.
								
		ИначеЕсли НаличиеФайлаОбменаXML И НаличиеФайлаОбменаZIP Тогда
			// сразу оба файла...
			// берем последний по времени
			ВремяФайлаXML = РаботаСФайлами.ПолучитьДатуФайла(ИтоговоеИмяФайлаОбменаДаннымиXML);
			ВремяФайлаZIP = РаботаСФайлами.ПолучитьДатуФайла(ИтоговоеИмяФайлаОбменаДаннымиZIP);
					
			Если ВремяФайлаXML >= ВремяФайлаZIP Тогда
				ИтоговоеИмяФайлаОбменаДанными = ИтоговоеИмяФайлаОбменаДаннымиXML;	
			Иначе
				ИтоговоеИмяФайлаОбменаДанными = ИтоговоеИмяФайлаОбменаДаннымиZIP;
			КонецЕсли;
					
			// сообщаем о том с каким файлом ведется обмен		
			СообщитьИнформациюОбОбмене("В каталоге обмена имеются 2 файла обмена информацией: " + ИмяФайлаПоУмолчаниюXML + ", " + ИмяФайлаПоУмолчаниюXML, 
				СтруктураНастроекОбменаДанными);
			// то что выбрали для обмена
			СообщитьИнформациюОбОбмене("Время записи/изменения файла : " + ИтоговоеИмяФайлаОбменаДанными + " больше. Он выбран для обмена данными.", 
				СтруктураНастроекОбменаДанными);
					
		ИначеЕсли НаличиеФайлаОбменаXML Тогда	
			// есть только XML файл
			ИтоговоеИмяФайлаОбменаДанными = ИтоговоеИмяФайлаОбменаДаннымиXML; 
					
		ИначеЕсли НаличиеФайлаОбменаZIP Тогда	
			// есть только ZIP
			ИтоговоеИмяФайлаОбменаДанными = ИтоговоеИмяФайлаОбменаДаннымиZIP;
					
		КонецЕсли; // наличие файлов приема
				
	КонецЕсли;	// производить прием сообщений
	
	// ничего не указано
	Если ПустаяСтрока(ИтоговоеИмяФайлаОбменаДанными) 
		И ПустаяСтрока(КаталогОбменаДанными) Тогда
		
		Возврат;
		
	КонецЕсли;
	Если ИмяПользователя() <> "Обмен" Тогда
		ИнициализироватьФормуХодаОбработки(СтруктураНастроекОбменаДанными, "Подготовка перед обменом данными", 5);
	КонецЕсли;
	
	
	// если задана переменная ИтоговоеИмяФайлаОбменаДанными тогда хотим и изменение получить и данные выгрузить
	Если Не ПустаяСтрока(ИтоговоеИмяФайлаОбменаДанными) Тогда
		
		// получаем дату последнего файла обмена
		СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена = РаботаСФайлами.ПолучитьДатуФайла(ИтоговоеИмяФайлаОбменаДанными);
		СтруктураНастроекОбменаДанными.ИмяВходящегоФайлаОбмена = ИтоговоеИмяФайлаОбменаДанными; 
		
		// копируем файл во временный каталог
		СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений = ВернутьИмяВременногоФайлаЧтенияДанных(СтруктураНастроекОбменаДанными, 
			(Врег(РаботаСФайлами.ПолучитьРасширениеФайла(ИтоговоеИмяФайлаОбменаДанными)) = "ZIP"));
				        		
		УдачноеКопирование = ВыполнитьКопированиеФайла(ИтоговоеИмяФайлаОбменаДанными, СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений, Истина, 
			СтруктураНастроекОбменаДанными);
			
		Если Не УдачноеКопирование Тогда
			СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений	= "";			
		КонецЕсли;	
		
		ИмяФайла = "";
		РаботаСФайлами.ПолучитьКаталогИИмяФайла(ИтоговоеИмяФайлаОбменаДанными, КаталогОбменаДанными, ИмяФайла);
		
	КонецЕсли;
	
	СтруктураНастроекОбменаДанными.НеобходимостьЗаписиОтветногоФайлаОбмена = СтруктураНастроекОбменаДанными.ПроизводитьЗаписьДанных;
	
	// весь обмен производим во временном каталоге
	СтруктураНастроекОбменаДанными.КаталогПроведенияОбменаДанными = КаталогОбменаДанными; 
	
КонецПроцедуры

// Процедура подготавливает обмен через FTP ресурс по настройке обмена данными
Процедура ПодготовитьОбменЧерезFTPРесурс(СтруктураНастроекОбменаДанными)
	
	Перем Соединение, ИмяFTPСервера, ИмяКаталогаСервера;
	
	ПроверитьНастройкиПодключения = ПроверитьНастройкиFTPПодключения(СтруктураНастроекОбменаДанными.ДанныеНастройки, 
		СтруктураНастроекОбменаДанными.ДанныеПротокола,	СтруктураНастроекОбменаДанными.ВывестиИнформациюВОкноСообщений, 
		ИмяКаталогаСервера, ИмяFTPСервера, Соединение);
		
	Если Не ПроверитьНастройкиПодключения Тогда
		Возврат;
	КонецЕсли;
		
	СтруктураНастроекОбменаДанными.НеобходимостьЗаписиОтветногоФайлаОбмена = СтруктураНастроекОбменаДанными.ПроизводитьЗаписьДанных;
		
	Если СтруктураНастроекОбменаДанными.ПроизводитьЧтениеДанных Тогда
		
		// ищем файлы по маске с расширением Message_A_B .xml или .zip
		ШаблонИмениФайла = СформироватьИмяФайлаОбменаМеждуУзлами(СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы, 
			СтруктураНастроекОбменаДанными.ТекущийУзелПланаОбмена, "") + ".*";
		
		МассивНайденныхФайлов = Соединение.НайтиФайлы(ИмяКаталогаСервера, ШаблонИмениФайла);
		
		СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена = ПолучитьДатуФайлаПоследнейЗагрузкиДанных(СтруктураНастроекОбменаДанными.ДанныеНастройки.Ссылка);
				
		Для Каждого ФайлФТП Из МассивНайденныхФайлов Цикл
			
			ТекущийФайлДляОбмена = ФайлФТП;
			
			// проверяем нужное расширение, то что это фай а не каталог, запоминаем последнюю дату файла
			Если НЕ( (Врег(ТекущийФайлДляОбмена.Расширение) = ".ZIP") ИЛИ (Врег(ТекущийФайлДляОбмена.Расширение) = ".XML") ) Тогда
				Продолжить;
			КонецЕсли;
			
			Если (ТекущийФайлДляОбмена.ЭтоФайл() = Ложь) Тогда
				Продолжить;
			КонецЕсли;
			
			Если (ТекущийФайлДляОбмена.Размер() = 0) Тогда
				Продолжить;
			КонецЕсли;
			
			// с датами определяемся
			ВремяИзмененияТекущегоФайла = ТекущийФайлДляОбмена.ПолучитьВремяИзменения();
			
			// закомментировали в целях борьбы с неправильным временем на FTP сервере (обнаружили в КофеШопе)
			////дата последнего файла обмена должна быть меньше текущего файла обмена
			//Если (СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена <> Неопределено) 
			//	И (СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена > ВремяИзмененияТекущегоФайла) Тогда
			//	
			//	Продолжить;
			//	
			//КонецЕсли;			
			
			// проверим что бы размер файла не превосходил ограничения по размеру
			Если (СтруктураНастроекОбменаДанными.ДанныеНастройки.МаксимальныйРазмерОтправляемогоПолучаемогоПакетаЧерезFTP > 0) 
				И (ТекущийФайлДляОбмена.Размер() / 1024) > СтруктураНастроекОбменаДанными.ДанныеНастройки.МаксимальныйРазмерОтправляемогоПолучаемогоПакетаЧерезFTP Тогда
				
				// файл не удовлетворяет ограничениям по размеру для получения через FTP
				Продолжить;	
						
			КонецЕсли;			
			
			ФайлДляОбмена = ТекущийФайлДляОбмена;
			СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена = ВремяИзмененияТекущегоФайла; 
			СтруктураНастроекОбменаДанными.ИмяВходящегоФайлаОбмена = ИмяFTPСервера + ФайлФТП.ПолноеИмя;
			
		КонецЦикла;	
			
		//надо переместить нужный файл в каталог для обмена данными
		Если ФайлДляОбмена <> Неопределено Тогда
			
			СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений = ВернутьИмяВременногоФайлаЧтенияДанных(СтруктураНастроекОбменаДанными, 
				(Врег(ФайлДляОбмена.Расширение) = ".ZIP"));
			
			Попытка
				// генерируем имя файла для чтения изменений и закачиваем этот файл
				Соединение.Получить(ФайлДляОбмена.ПолноеИмя, СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений);	
				
			Исключение
			
				СообщитьИнформациюОбОшибкеОбмена("Ошибка при копировании файла c FTP ресурса: " + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);
				СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений = "";
							
			КонецПопытки;
				
		Иначе
			
			Если (МассивНайденныхФайлов.Количество() > 0)
				И ЗначениеЗаполнено(СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена) Тогда
				
				//файлы то есть но ни один не подходит
				СообщитьИнформациюОбОбмене("Возможно дата файлов обмена не превосходит дату последнего файла обмена данными через FTP: " + Строка(СтруктураНастроекОбменаДанными.ДатаПоследнегоФайлаОбмена), 
					СтруктураНастроекОбменаДанными);
				
			КонецЕсли;
			
			СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений = "";		
		КонецЕсли;
		
	КонецЕсли; // надо читать данные с FTP	
	
	Если СтруктураНастроекОбменаДанными.ПроизводитьЗаписьДанных
		ИЛИ Не ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений) Тогда

		ИнициализироватьФормуХодаОбработки(СтруктураНастроекОбменаДанными, "Подготовка перед обменом данными", 5);
	
	КонецЕсли;
	
КонецПроцедуры

// СЛУЖЕБНЫЕ ФУНКЦИЯ ВЫПОЛНЯЮЩИЕСЯ ПОСЛЕ ОБМЕНА
///////////////////////////////////////////////////////////////////////////////

//Процедура удаляет не нужные файлы после обмена данными
Процедура УдалитьФайлаПослеОбменаДанными(СтруктураНастроекОбменаДанными)
	
	Если ОпределитьБылоУдачноПроизведеноЧтениеДанных(СтруктураНастроекОбменаДанными)
		И (Не СтруктураНастроекОбменаДанными.РучнойРежимЗапуска) Тогда
		
		ВыполнитьУдалениеФайла(СтруктураНастроекОбменаДанными.ИмяВходящегоФайлаОбмена, СтруктураНастроекОбменаДанными, Истина);
		
	КонецЕсли;
	
	// временный файл для чтения данных надо грохнуть вне зависимости от результатов чтения
	ВыполнитьУдалениеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений, СтруктураНастроекОбменаДанными);
	
КонецПроцедуры

//Функция по структуре возвращает была ли произведена запись данных
Функция ОпределитьБылаУдачноПроизведенаЗаписьДанных(СтруктураНастроекОбменаДанными)
	
	Возврат СтруктураНастроекОбменаДанными.РезультатЗаписиДанных 
		И Не ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений);
	
КонецФункции

//Функция по структуре возвращает было ли произведено чтение данных
Функция ОпределитьБылоУдачноПроизведеноЧтениеДанных(СтруктураНастроекОбменаДанными)
	
	Возврат СтруктураНастроекОбменаДанными.РезультатЧтенияДанных 
		И Не ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений)
	
КонецФункции
    
// функция определяет нужно отправлять ответный пакет или нет
Функция ОпределитьНужноОтправлятьОтветныйПакет(СтруктураНастроекОбменаДанными)
	
	МаксимальныйДопустимыйРазмерСообщения = СтруктураНастроекОбменаДанными.ДанныеНастройки.МаксимальныйРазмерОтправляемогоПолучаемогоПакетаЧерезFTP;
	
	// нужно предварительно проанализировать что бы размер отправляемого письма не превосходил ограничений
	Если МаксимальныйДопустимыйРазмерСообщения = 0 Тогда
		Возврат Истина;
	КонецЕсли;
			
	// ограничение на размер ответного письма есть, нужно сравнить это значение с размером отправляемого файла
	ФайлДляОправки = Новый Файл(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений);
	Если ФайлДляОправки.Существует() Тогда
				
		РазмерОтправляемогоФайла = ФайлДляОправки.Размер();
				
		Если (РазмерОтправляемогоФайла / 1024) > МаксимальныйДопустимыйРазмерСообщения Тогда
					
			// файл превысил допустимый для отправки размер
			СообщитьИнформациюОбОбмене("Ответный пакет не был отправлен. Размер исходящего пакета составил: " + Окр(РазмерОтправляемогоФайла / 1024, 2) + 
				" (КБт) что превышает допустимое ограничение " + МаксимальныйДопустимыйРазмерСообщения + " (КБт)", 
				СтруктураНастроекОбменаДанными);
				
			Возврат Ложь;	
					
		КонецЕсли;
				
	КонецЕсли;
	
	Возврат Истина;
		
КонецФункции
    
// Процедура выполняет действия после обмена через файловый ресурс
Процедура ДействияПослеОбменаЧерезФайловыйРесурс(СтруктураНастроекОбменаДанными)
	
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Окончание обмена данными", 5);
	
	// надо файл скопировать обратно из временного каталога в основной			
	Если ОпределитьБылаУдачноПроизведенаЗаписьДанных(СтруктураНастроекОбменаДанными) Тогда
		
		ИмяФайла = РаботаСФайлами.ПолучитьИмяФайлаИзПолногоПути(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений);
						
		ИмяФайлаДляЗаписиВКаталогОбмена = СтруктураНастроекОбменаДанными.КаталогПроведенияОбменаДанными + "\" + ИмяФайла;
		
		// копируем файл
		УдачноеКопирование = ВыполнитьКопированиеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, ИмяФайлаДляЗаписиВКаталогОбмена, Истина, 
			СтруктураНастроекОбменаДанными);
		
		Если Не УдачноеКопирование Тогда
				
			СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;
			
		Иначе
			
			// удаляем не нужный файл обмена
			ВыполнитьУдалениеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, СтруктураНастроекОбменаДанными);
						
		КонецЕсли;
		
	КонецЕсли;
	
	// удаляем файлы обмена
	УдалитьФайлаПослеОбменаДанными(СтруктураНастроекОбменаДанными);
		
КонецПроцедуры			
			
// Процедура выполняет действия после обмена через FTP ресурс
Процедура ДействияПослеОбменаЧерезFTPРесурс(СтруктураНастроекОбменаДанными)
	
	Перем Соединение, ИмяFTPСервера, ИмяКаталогаСервера;

	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Окончание обмена данными", 5);
	
	Если ОпределитьБылаУдачноПроизведенаЗаписьДанных(СтруктураНастроекОбменаДанными) Тогда
		
		НужноЗаписатьФайлНаFTP = ОпределитьНужноОтправлятьОтветныйПакет(СтруктураНастроекОбменаДанными);
		
		Если НужноЗаписатьФайлНаFTP Тогда
		
			ПроверитьНастройкиПодключения = ПроверитьНастройкиFTPПодключения(СтруктураНастроекОбменаДанными.ДанныеНастройки, 
				СтруктураНастроекОбменаДанными.ДанныеПротокола,	СтруктураНастроекОбменаДанными.ВывестиИнформациюВОкноСообщений, 
				ИмяКаталогаСервера, ИмяFTPСервера, Соединение);
				
			Если Не ПроверитьНастройкиПодключения Тогда
				Возврат;
			КонецЕсли;
			
			ИмяФайлаFTPЗаписи = ИмяКаталогаСервера + РаботаСФайлами.ПолучитьИмяФайлаИзПолногоПути(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений);
			
			Попытка
				
				Если ПроверитьНастройкиПодключения Тогда  
					
					ДобавитьИнформациюВПротокол("Копирование файла обмена на FTP ресурс", СтруктураНастроекОбменаДанными.ДанныеПротокола);
					Соединение.Записать(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, ИмяФайлаFTPЗаписи);
					
				Иначе	
					СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;	
				КонецЕсли;
				
			Исключение
				
				СтруктураНастроекОбменаДанными.РезультатЗаписиДанных = Ложь;
				СообщитьИнформациюОбОбмене("Ошибка при копировании файла на FTP ресурс: " + ОписаниеОшибки(), СтруктураНастроекОбменаДанными);	
			
			КонецПопытки;
			
		КонецЕсли;	
		
		ВыполнитьУдалениеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, СтруктураНастроекОбменаДанными);
	КонецЕсли;

	// удаляем файлы обмена
	УдалитьФайлаПослеОбменаДанными(СтруктураНастроекОбменаДанными);
				
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////

// Процедура устанавливает необходимость выполнения обмена данными при первом запуске программы
Процедура УстановитьНеобходимостьВыполненияОбменаПриПервомЗапускеПрограммы(НастройкаОбмена, Знач ВыполнятьОбменПриПервомЗапуске) Экспорт
	
	НаборЗаписейПараметров = РегистрыСведений.ПараметрыОбменаДанными.СоздатьНаборЗаписей();
	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Значение = НастройкаОбмена;	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Использование = Истина;
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.ВидСравнения = ВидСравнения.Равно;
	
	НаборЗаписейПараметров.Прочитать();
	
	Если НаборЗаписейПараметров.Количество() = 0 Тогда
		ЗаписьПараметров = НаборЗаписейПараметров.Добавить();
	Иначе
		ЗаписьПараметров = НаборЗаписейПараметров[0];
	КонецЕсли;
	
	ЗаписьПараметров.НастройкаОбменаДанными = НастройкаОбмена;
	ЗаписьПараметров.ВыполнятьПриПервомВходеВСистему = ВыполнятьОбменПриПервомЗапуске;
		
	Попытка
		НаборЗаписейПараметров.Записать();
	Исключение
		
		СообщитьИнформациюОПростойОшибке("Ошибка при записи изменений в настройку обмена """ + НастройкаОбмена + """ : " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

// Процедура устанавливает необходимость выполнения обмена данными при первом запуске программы
Процедура УстановитьДоступностьКаталогаДляПроверки(НастройкаОбмена, Знач ДоступностьКаталога) Экспорт

	// устанавливаем у регистра параметров обмена новое значение доступности каталога
	НаборЗаписейПараметров = РегистрыСведений.ПараметрыОбменаДанными.СоздатьНаборЗаписей();
	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Значение = НастройкаОбмена;	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Использование = Истина;
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.ВидСравнения = ВидСравнения.Равно;
		
	НаборЗаписейПараметров.Прочитать();
		
	Если НаборЗаписейПараметров.Количество() = 0 Тогда
		ЗаписьПараметров = НаборЗаписейПараметров.Добавить();
	Иначе
		ЗаписьПараметров = НаборЗаписейПараметров[0];
	КонецЕсли;
		
	ЗаписьПараметров.НастройкаОбменаДанными = НастройкаОбмена;
	ЗаписьПараметров.ДоступностьКаталогаПроверки = ДоступностьКаталога;
			
	Попытка
		НаборЗаписейПараметров.Записать();
	Исключение
		
		СообщитьИнформациюОПростойОшибке("Ошибка при записи изменений в настройку обмена """ + НастройкаОбмена + """ : " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры	


// ФУНКЦИЯ ОБМЕНА ДАННЫМИ ПО НАСТРОЙКЕ

// регистрирует что обмен был произведен и фиксирует информацию в протоколе
Процедура ЗафиксироватьЗавершениеОбмена(СтруктураДанныхНастройкиОбмена, Знач СтрокаСообщенияОбОшибке = "", Знач НеВыводитьИнформациюПользователю = Ложь)
	
	Если Не ПустаяСтрока(СтрокаСообщенияОбОшибке) Тогда
		
		Если НеВыводитьИнформациюПользователю Тогда
			ДобавитьИнформациюВПротокол(СтрокаСообщенияОбОшибке, СтруктураДанныхНастройкиОбмена.ДанныеПротокола, Ложь, Истина);
		Иначе
			СообщитьИнформациюОбОшибкеОбмена(СтрокаСообщенияОбОшибке, СтруктураДанныхНастройкиОбмена);
		КонецЕсли;
		
	КонецЕсли;	
	
	ДатаПоследнегоОбмена = ТекущаяДата();
	// записываем в объект дату последнего обмена
	НаборЗаписейПараметров = РегистрыСведений.ПараметрыОбменаДанными.СоздатьНаборЗаписей();
	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Значение = СтруктураДанныхНастройкиОбмена.ДанныеНастройки.Ссылка;	
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.Использование = Истина;
	НаборЗаписейПараметров.Отбор.НастройкаОбменаДанными.ВидСравнения = ВидСравнения.Равно;
	
	НаборЗаписейПараметров.Прочитать();
	
	Если НаборЗаписейПараметров.Количество() = 0 Тогда
		ЗаписьПараметров = НаборЗаписейПараметров.Добавить();
	Иначе
		ЗаписьПараметров = НаборЗаписейПараметров[0];
	КонецЕсли;
	
	ЗаписьПараметров.НастройкаОбменаДанными = СтруктураДанныхНастройкиОбмена.ДанныеНастройки.Ссылка;
	ЗаписьПараметров.ДатаПоследнегоОбмена = ДатаПоследнегоОбмена;
		
	// дата и результат последней выгрузки и загрузки
	Если ЗначениеЗаполнено(СтруктураДанныхНастройкиОбмена.ДатаПоследнейЗагрузки)
		И НЕ ПустаяСтрока(СтруктураДанныхНастройкиОбмена.ИмяФайлаЧтенияИзменений) Тогда
		
		ЗаписьПараметров.ДатаПоследнейЗагрузки = СтруктураДанныхНастройкиОбмена.ДатаПоследнейЗагрузки;	
		ЗаписьПараметров.РезультатПоследнейЗагрузки = СтруктураДанныхНастройкиОбмена.РезультатЧтенияДанных;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураДанныхНастройкиОбмена.ДатаПоследнейВыгрузки)
		И НЕ ПустаяСтрока(СтруктураДанныхНастройкиОбмена.ИмяФайлаЗаписиИзменений) Тогда
		
		ЗаписьПараметров.ДатаПоследнейВыгрузки = СтруктураДанныхНастройкиОбмена.ДатаПоследнейВыгрузки;	
		ЗаписьПараметров.РезультатПоследнейВыгрузки = СтруктураДанныхНастройкиОбмена.РезультатЗаписиДанных;
		
	КонецЕсли;
	
	// записываем дату последнего файла обмена только в том случае, если обмен произошел успешно
	УдачноеЧтение = ОпределитьБылоУдачноПроизведеноЧтениеДанных(СтруктураДанныхНастройкиОбмена);
	Если УдачноеЧтение Тогда
		ЗаписьПараметров.ДатаПоследнегоФайлаОбмена = СтруктураДанныхНастройкиОбмена.ДатаПоследнегоФайлаОбмена;
	КонецЕсли;
	
	ЗаписьПараметров.ВыполнятьПриПервомВходеВСистему = Ложь;
	ЗаписьПараметров.ДоступностьКаталогаПроверки = СтруктураДанныхНастройкиОбмена.ДоступностьКаталогаПроверки;
		
	Попытка
		НаборЗаписейПараметров.Записать();
	Исключение
		
		Если НеВыводитьИнформациюПользователю Тогда
			ДобавитьИнформациюВПротокол("Ошибка при записи изменений в настройку обмена """ + СтруктураДанныхНастройкиОбмена.ДанныеНастройки.Ссылка + """ : " + ОписаниеОшибки(), 
				СтруктураДанныхНастройкиОбмена.ДанныеПротокола, Ложь, Истина);	
		Иначе	
			СообщитьИнформациюОбОшибкеОбмена("Ошибка при записи изменений в настройку обмена """ + СтруктураДанныхНастройкиОбмена.ДанныеНастройки.Ссылка + """ : " + ОписаниеОшибки(), 
				СтруктураДанныхНастройкиОбмена);
		КонецЕсли;	
		
	КонецПопытки;	
		
	// надо изменения отразить в обработке автоматического поиска
	Если СтруктураДанныхНастройкиОбмена.ОбработкаАвтоОбменДанными <> Неопределено Тогда
		
		СтруктураДанныхНастройкиОбмена.ОбработкаАвтоОбменДанными.ОбновитьИнформациюОНастройкахОбмена(СтруктураДанныхНастройкиОбмена.ДанныеНастройки, 
			ДатаПоследнегоОбмена, СтруктураДанныхНастройкиОбмена.ДоступностьКаталогаПроверки);
			
	КонецЕсли;
	
	ЗаписатьДанныеПротокола(СтруктураДанныхНастройкиОбмена.ДанныеНастройки, СтруктураДанныхНастройкиОбмена.ДанныеПротокола, НЕ ПустаяСтрока(СтрокаСообщенияОбОшибке));
    	
КонецПроцедуры

// Процедура возвращает параметры для обмена
Процедура ПолучитьПараметрыОбменаДанными(СтруктураНастроекОбменаДанными, МетаданныеУзлаОбмена, СтрокаИнформацияОбОбмене)
	
	// получаем узел информационной базы плана обмена
	ИмяПланаОбмена = ПолучитьИмяПланаОбмена(СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы);
	МетаданныеУзлаОбмена = СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы.Метаданные();
	
	СтрокаОписанияЗапуска = ?(СтруктураНастроекОбменаДанными.РучнойРежимЗапуска, "в интерактивном режиме", "в автоматическом режиме");
	СтрокаИнформацияОбОбмене = "обмена данными " + СтрокаОписанияЗапуска + " для плана обмена """ + ИмяПланаОбмена + """ узла """ + СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы.Наименование + """";
	
КонецПроцедуры

//Функция проводит необходимые действия перед началом обмена данными
// возвращает нужно ли производить обмен или нет
Функция ВыполнитьДействияПередНачаломОбменаДанными(СтруктураНастроекОбменаДанными)
	
	СтруктураНастроекОбменаДанными.Вставить("ДанныеПротокола", "");
	
	СтруктураНастроекОбменаДанными.Вставить("ДатаПоследнегоФайлаОбмена", Неопределено);
	
	СтруктураНастроекОбменаДанными.Вставить("ДатаПоследнейЗагрузки", Неопределено);
	СтруктураНастроекОбменаДанными.Вставить("ДатаПоследнейВыгрузки", Неопределено);
		
	СтруктураНастроекОбменаДанными.Вставить("ИмяФайлаЧтенияИзменений", "");
	СтруктураНастроекОбменаДанными.Вставить("ИмяФайлаЗаписиИзменений", "");
	
	СтруктураНастроекОбменаДанными.Вставить("РезультатЧтенияДанных", Ложь);
	СтруктураНастроекОбменаДанными.Вставить("РезультатЗаписиДанных", Ложь);
	
	СтруктураНастроекОбменаДанными.Вставить("НеобходимостьЗаписиОтветногоФайлаОбмена", Ложь);

		
	// если это автообмен надо проверить выполнение доп.условий
	Если НЕ СтруктураНастроекОбменаДанными.РучнойРежимЗапуска Тогда
		
		Если Не ПустаяСтрока(СтруктураНастроекОбменаДанными.ДанныеНастройки.НаличиеКаталогаДляЗапускаАвтообмена) Тогда
			
			// наличие каталога 
			НаличиеКаталога = ПроверитьНаличиеКаталога(СтруктураНастроекОбменаДанными.ДанныеНастройки.НаличиеКаталогаДляЗапускаАвтообмена, Истина);
			
			Если Не НаличиеКаталога Тогда
				
				ДобавитьИнформациюВПротокол(Символы.ПС, СтруктураНастроекОбменаДанными.ДанныеПротокола);
				ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "Для автообмена не выполнено условие наличия каталога: " + 
					СтруктураНастроекОбменаДанными.ДанныеНастройки.НаличиеКаталогаДляЗапускаАвтообмена, Истина);
				Возврат Ложь;
				
			Иначе
				
				ДобавитьИнформациюВПротокол("Выполнено условие наличия каталога: " + СтруктураНастроекОбменаДанными.ДанныеНастройки.НаличиеКаталогаДляЗапускаАвтообмена,
					СтруктураНастроекОбменаДанными.ДанныеПротокола);	
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ПустаяСтрока(СтруктураНастроекОбменаДанными.ДанныеНастройки.ОтсутствиеКаталогаДляЗапускаАвтообмена) Тогда
			
			// наличие каталога 
			НаличиеКаталога = ПроверитьНаличиеКаталога(СтруктураНастроекОбменаДанными.ДанныеНастройки.ОтсутствиеКаталогаДляЗапускаАвтообмена, Истина);
			
			Если НаличиеКаталога Тогда
				
				ДобавитьИнформациюВПротокол(Символы.ПС, СтруктураНастроекОбменаДанными.ДанныеПротокола);
				ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "Для автообмена не выполнено условие отсутствия каталога: " + 
					СтруктураНастроекОбменаДанными.ДанныеНастройки.ОтсутствиеКаталогаДляЗапускаАвтообмена, Истина);
				Возврат Ложь;
				
			Иначе	
				
				ДобавитьИнформациюВПротокол("Выполнено условие отсутствия каталога: " + СтруктураНастроекОбменаДанными.ДанныеНастройки.ОтсутствиеКаталогаДляЗапускаАвтообмена,
					СтруктураНастроекОбменаДанными.ДанныеПротокола);
					
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	СообщитьИнформациюОбОбмене(Символы.ПС, СтруктураНастроекОбменаДанными);
			
	// информация об обмене данными
	Если СтруктураНастроекОбменаДанными.РучнойРежимЗапуска Тогда
			
		СтрокаЗаписиВЛогПриНачалеОбмена = "Начат обмен данными";
			
	Иначе
			
		Если НЕ СтруктураНастроекОбменаДанными.ОбменПриВходеВПрограмму Тогда
			СтрокаЗаписиВЛогПриНачалеОбмена = "Начат автоматический обмен данными";
		Иначе
			СтрокаЗаписиВЛогПриНачалеОбмена = "Начат автоматический обмен данными при первом входе в программу";
		КонецЕсли;
			
	КонецЕсли;	
		
	СтрокаЗаписиВЛогПриНачалеОбмена = СтрокаЗаписиВЛогПриНачалеОбмена + " по настройке """ + Строка(СтруктураНастроекОбменаДанными.ДанныеНастройки) + """ (" + Формат(ТекущаяДата(), "ДЛФ=В") + ").";	
		
	СообщитьИнформациюОбОбмене(СтрокаЗаписиВЛогПриНачалеОбмена, СтруктураНастроекОбменаДанными);
			
	#Если Клиент Тогда
			
		Если НЕ СтруктураНастроекОбменаДанными.ОбменПриВходеВПрограмму Тогда
				
			// для автоматического режима запуска обмена спрашиваем хочет ли он произвести этот обмен
			Если Не СтруктураНастроекОбменаДанными.РучнойРежимЗапуска
				И СтруктураНастроекОбменаДанными.ДанныеНастройки.ВопросПриАвтообмене Тогда
				
				// Текст вопроса об автообмене
				ТекстВопроса = "Вы хотите автоматически произвести обмен данными по настройке """ + Строка(СтруктураНастроекОбменаДанными.ДанныеНастройки.ссылка) + """?";

				// Определяем пользьзователь в РМ
				ПользовательРМ = НЕ глПользователь = Неопределено;
				
				// Задаем вопрос в зависимости от пользователя интерфейса РМ или нет
				Если ПользовательРМ Тогда
					Текст1="ВНИМАНИЕ!";
					ОтветПользователяДа = ИнтерфейсРМ.ВопросПредупреждение("Вопрос", Текст1, ТекстВопроса, "ОК", "", "Esc=Отмена")="ОК";
				Иначе	
					ОтветПользователяДа = КодВозвратаДиалога.ДА = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.ДА, "Обмен данными");
				КонецЕсли;	
				
				Если НЕ ОтветПользователяДа Тогда
					// пользователь не хочет производить обмен
					
					// Для пользователя РМ отменяем отметку о видимости каталога (Вопрос об обмене будет выскакивать пока не нажмет "ДА")
					Если ПользовательРМ Тогда
						СтруктураНастроекОбменаДанными.ДоступностьКаталогаПроверки = Ложь;
					КонецЕсли;	
					
					ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "Обмен данными отменен пользователем!");
					Возврат Ложь;
						
				Иначе
					// пользователь согласился выполнять обмен			
					ДобавитьИнформациюВПротокол("Пользователь положительно ответил на вопрос о проведении автоматического обмена", СтруктураНастроекОбменаДанными.ДанныеПротокола);
						
				КонецЕсли;	
						
			КонецЕсли;
				
		КонецЕсли;	
			
	#КонецЕсли	
		
	Если НЕ ЗначениеЗаполнено(СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы) Тогда
			
		// надо зафиксировать что обмен произведен и в следующий раз не предлагать еще раз сделать обмен данными
		ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "В настройке обмена не задан узел информационной базы с которым нужно производить обмен информацией! Обмен отменен.");
		Возврат Ложь;
			
	КонецЕсли;
		
	Если НЕ СтруктураНастроекОбменаДанными.ПроизводитьЧтениеДанных 
		И НЕ СтруктураНастроекОбменаДанными.ПроизводитьЗаписьДанных Тогда
			
		ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "В настройке обмена не взведены флаги загрузки и выгрузки данных! Обмен отменен.");
		Возврат Ложь;
			
	КонецЕсли;
	
	МетаданныеУзлаОбмена = Неопределено;
	СтрокаИнформацияОбОбмене = "";
	ПолучитьПараметрыОбменаДанными(СтруктураНастроекОбменаДанными, МетаданныеУзлаОбмена, СтрокаИнформацияОбОбмене);
	
	СтруктураНастроекОбменаДанными.Вставить("ТекущийУзелПланаОбмена", ПланыОбмена[МетаданныеУзлаОбмена.Имя].ЭтотУзел());
		
	// сами с собой не обмениваемся
	Если СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы = СтруктураНастроекОбменаДанными.ТекущийУзелПланаОбмена Тогда
			
		ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "Нельзя организовать обмен данными с текущим узлом информационной базы! Обмен отменен.");
		Возврат Ложь;
			
	КонецЕсли;
	
	// у узлов участвующих в обмене должен быть не пустой код
	Если ПустаяСтрока(Строка(СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы.Код)) 
		ИЛИ ПустаяСтрока(Строка(СтруктураНастроекОбменаДанными.ТекущийУзелПланаОбмена.Код)) Тогда
		
		ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, "Нельзя организовать обмен данными когда один из узлов обмена имеет пустой код! Обмен отменен.");
		Возврат Ложь;
		
	КонецЕсли;
	
	// записываем в журнал данные о начале обмена данными
	ЗарегистрироватьСобытие("ИнформационнаяБаза.АвтоматическийОбменДанными", УровеньЖурналаРегистрации.Информация, 
		МетаданныеУзлаОбмена, СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы, "Начало " + СтрокаИнформацияОбОбмене);
	
	Возврат Истина;
	
КонецФункции

//функция выполняется после завершения обменом данными
Функция ВыполнитьДействияПослеЗавершенияОбменаДанными(СтруктураНастроекОбменаДанными)
	
	МетаданныеУзлаОбмена = Неопределено;
	СтрокаИнформацияОбОбмене = "";
	ПолучитьПараметрыОбменаДанными(СтруктураНастроекОбменаДанными, МетаданныеУзлаОбмена, СтрокаИнформацияОбОбмене);
	
	// отмечаем то что обмен произведен
	
	СообщитьИнформациюОбОбмене("Обмен данными по настройке """ + Строка(СтруктураНастроекОбменаДанными.ДанныеНастройки) + """ завершен (" + Формат(ТекущаяДата(), "ДЛФ=В") + ").", 
		СтруктураНастроекОбменаДанными);
	
	ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными);
		
	ОтобразитьНовоеСообщениеВФормеХодаОбработки(СтруктураНастроекОбменаДанными, "Обмен данными завершен", 5);	
		
	// записываем в журнал данные об окончании обмена данными
	ЗарегистрироватьСобытие("ИнформационнаяБаза.АвтоматическийОбменДанными", УровеньЖурналаРегистрации.Информация, 
		МетаданныеУзлаОбмена, СтруктураНастроекОбменаДанными.ДанныеНастройки.УзелИнформационнойБазы, "Окончание " + СтрокаИнформацияОбОбмене);	
			
	ЗаписатьДанныеПротокола(СтруктураНастроекОбменаДанными.ДанныеНастройки, СтруктураНастроекОбменаДанными.ДанныеПротокола, Ложь);
		
	ЗакрытьФормуОбработкиДанных(СтруктураНастроекОбменаДанными);
	
	Возврат Истина;
	
КонецФункции

// Процедура производит обмен данными по настройке обмена
Процедура ПроизвестиОбменДаннымиПоНастройке(СтруктураНастроекОбменаДанными) Экспорт
	
	// начальные функции инициализации обмена
	РезультатаНачалаОбмена = ВыполнитьДействияПередНачаломОбменаДанными(СтруктураНастроекОбменаДанными);
	Если Не РезультатаНачалаОбмена Тогда
		Возврат;
	КонецЕсли;
		
	Попытка
					
		// ПОДГОТОВКА ПЕРЕД ОБМЕНОМ
		Если СтруктураНастроекОбменаДанными.ДанныеНастройки.ТипНастройки = Перечисления.ТипыАвтоматическогоОбменаДанными.ОбменЧерезФайловыйРесурс Тогда
			
			СтруктураНастроекОбменаДанными.Вставить("КаталогПроведенияОбменаДанными", "");
			СтруктураНастроекОбменаДанными.Вставить("ИмяВходящегоФайлаОбмена", "");
			ПодготовитьОбменЧерезФайловыйРесурс(СтруктураНастроекОбменаДанными);
			
		ИначеЕсли СтруктураНастроекОбменаДанными.ДанныеНастройки.ТипНастройки = Перечисления.ТипыАвтоматическогоОбменаДанными.ОбменЧерезFTPРесурс Тогда
			
			СтруктураНастроекОбменаДанными.Вставить("ИмяВходящегоФайлаОбмена", "");
			ПодготовитьОбменЧерезFTPРесурс(СтруктураНастроекОбменаДанными);
			
		КонецЕсли;
		
		// файл для записи изменений
		Если СтруктураНастроекОбменаДанными.НеобходимостьЗаписиОтветногоФайлаОбмена Тогда 
			
			СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений = ВернутьИмяВременногоФайлаЗаписиДанных(СтруктураНастроекОбменаДанными);
			
			Если СтруктураНастроекОбменаДанными.ДанныеНастройки.ВыполнятьАрхивациюФайловОбмена Тогда
				
				РаботаСФайлами.УстановитьРасширениеФайла(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений, ".zip");
				
			КонецЕсли;
			
		КонецЕсли;
		
		// если ничего делать не надо, то выходим вообще
		Если ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЧтенияИзменений)
			И ПустаяСтрока(СтруктураНастроекОбменаДанными.ИмяФайлаЗаписиИзменений) Тогда
			
			СообщитьИнформациюОбОбмене("Ни загрузка ни выгрузка данных не были произведены", СтруктураНастроекОбменаДанными);
			ЗакрытьФормуОбработкиДанных(СтруктураНастроекОбменаДанными);
			ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными);
			Возврат;
			
		КонецЕсли;
					
		// САМ ОБМЕН ДАННЫМИ
		ВыполнитьЗагрузкуДанныхИзФайлаОбмена(СтруктураНастроекОбменаДанными);
		
		ВыполнитьВыгрузкуДанныхВФайлОбмена(СтруктураНастроекОбменаДанными);
								
		// ДЕЙСТВИЯ ПОСЛЕ ОБМЕНА
		Если СтруктураНастроекОбменаДанными.ДанныеНастройки.ТипНастройки = Перечисления.ТипыАвтоматическогоОбменаДанными.ОбменЧерезФайловыйРесурс Тогда
				
			ДействияПослеОбменаЧерезФайловыйРесурс(СтруктураНастроекОбменаДанными);
					
		ИначеЕсли СтруктураНастроекОбменаДанными.ДанныеНастройки.ТипНастройки = Перечисления.ТипыАвтоматическогоОбменаДанными.ОбменЧерезFTPРесурс Тогда
				
			ДействияПослеОбменаЧерезFTPРесурс(СтруктураНастроекОбменаДанными);
								
		КонецЕсли;
		
		// оставшееся действия после обмена данными выполняем
		ВыполнитьДействияПослеЗавершенияОбменаДанными(СтруктураНастроекОбменаДанными);
				
	Исключение
		
		СтрокаОписанияОшибки = ОписаниеОшибки();
		// отмечаем то что обмен произведен
		ЗафиксироватьЗавершениеОбмена(СтруктураНастроекОбменаДанными, СтрокаОписанияОшибки);
		
		ЗакрытьФормуОбработкиДанных(СтруктураНастроекОбменаДанными);
		// прокидываем ошибку дальше
		ВызватьИсключение СтрокаОписанияОшибки;
		
	КонецПопытки;
		
	#Если Клиент Тогда
		//Состояние("");
	#КонецЕсли
	
КонецПроцедуры

// Процедура производит обмен по списку настроек для обмена
Процедура ПроизвестиСписокОбменовДанными(МассивНастроекОбмена, Знач РучнойРежимЗапуска = Ложь, ОбработкаАвтоОбменДанными = Неопределено,
			Знач ОбменПриВходеВПрограмму = Ложь) Экспорт
			
	Перем КоличествоПроизведенныхОбменов;		
			
	// если нет данных для обмена, то ничего не производим		
	Если МассивНастроекОбмена = Неопределено Тогда
		Возврат;		
	КонецЕсли;
	
	УправлениеРИБ.ПроизвестиСписокОбменовДанными(МассивНастроекОбмена, РучнойРежимЗапуска, ОбработкаАвтоОбменДанными, ОбменПриВходеВПрограмму, КоличествоПроизведенныхОбменов);
	
	#Если Клиент Тогда

	// сообщаем что обмен данными завершен
	Если РучнойРежимЗапуска Тогда 		
		
		Если КоличествоПроизведенныхОбменов > 0 Тогда
			Сообщить("Обмен данными завершен.");
		Иначе
			Предупреждение("Обмен данными не был выполнен.", 30, "Обмен данными");
		КонецЕсли;
		
	КонецЕсли;
				
	#КонецЕсли
	
КонецПроцедуры

// Выполняет обмен данными по расписанию.
//
// Параметры:
//  КодНастройки - код настройки обмена данными.
//
Процедура ВыполнитьОбменДаннымиДляНастройкиОбмена(КодНастройки) Экспорт
	
	Если НЕ ЗначениеЗаполнено(КодНастройки) Тогда
		Возврат;
	КонецЕсли;
	
	НастройкаОбмена = Справочники.НастройкиОбменаДанными.НайтиПоКоду(КодНастройки);
	
	Если НЕ ЗначениеЗаполнено(НастройкаОбмена) Тогда
		Возврат;
	КонецЕсли;
	
	Если НастройкаОбмена.ПометкаУдаления Тогда
		Возврат;
	КонецЕсли;
	
	МассивНастроекОбмена = Новый Массив();
	МассивНастроекОбмена.Добавить(НастройкаОбмена);
	
	ПроцедурыОбменаДанными.ПроизвестиСписокОбменовДанными(МассивНастроекОбмена);
	
КонецПроцедуры


// АВТОМАТИЧЕСКИЙ ОБМЕН ДАННЫМИ
///////////////////////////////////////////////////////////////////////////////

// Функция инициализирует автоматический автообмен 
Функция ВыполнитьИнициализациюАвтообменаПриНачалеРаботы() Экспорт
	
	// автообмен данными
	Если ПравоДоступа("Использование", Метаданные.Обработки.АвтоОбменДанными) Тогда
		
		// производим отложенный обмен при первом входе в программу
		ОбработкаАвтоОбменДанными = Обработки.АвтоОбменДанными.Создать(); 
			
		// обмен при первом входе
		ОбработкаАвтоОбменДанными.ПроизвестиОбменПриВходеВыходе(Истина);
			
		// отдельно получаем настройки для которых нужно выполнить обмен при входе в программу
		ОбработкаАвтоОбменДанными.ПроизвестиОбменПриВходеВыходе(, Истина);
			
		// получаем данные периодического обмена данными и с ними работаем
		ОбработкаАвтоОбменДанными.ОбновитьТабличнуюЧастьАвтоматическихОбменов();
		
		Возврат  ОбработкаАвтоОбменДанными
			
	Иначе
		
		Возврат Неопределено;
		
	КонецЕсли;
	
КонецФункции

// выполнение обмена данными при завершении работы программы
Процедура ВыполнитьОбменПриЗавершенииРаботыПрограммы(ОбработкаОбмена) Экспорт
	
	Если (ОбработкаОбмена <> Неопределено) Тогда
		
		// отдельно получаем настройки для которых нужно выполнить обмен при выходе из программы
		ОбработкаОбмена.ПроизвестиОбменПриВходеВыходе( ,, Истина);
			
	КонецЕсли;
	
КонецПроцедуры
                                                                            
// Функция возвращает количество секунд для проверки запуска автоматического обмена данными
Функция ПолучитьКоличествоСекундОпросаЗапускаОбменаДанными() Экспорт
	
	Возврат 60;
	
КонецФункции